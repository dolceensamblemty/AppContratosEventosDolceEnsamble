<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dolce Ensamble - Gesti√≥n de Contratos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, deleteDoc, query, orderBy, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBEPQwNyDTwj7-5fC0ksJQH6JRBmzielBA",
            authDomain: "app-contratos-dolce-ensamble.firebaseapp.com",
            projectId: "app-contratos-dolce-ensamble",
            storageBucket: "app-contratos-dolce-ensamble.firebasestorage.app",
            messagingSenderId: "892161363930",
            appId: "1:892161363930:web:c98f9f7ed7bc53e3c63ae3c63ae3",
            measurementId: "G-NF3HCSFY7Y"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db;
        window.firestore = { collection, addDoc, getDocs, doc, getDoc, updateDoc, deleteDoc, query, orderBy, where };
    </script>
    <style>
        .signature-pad {
            border: 2px dashed #d1d5db;
            cursor: crosshair;
        }
        .contract-bg {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            position: relative;
        }
        .elegant-border {
            border: 3px solid #8b5a3c;
            border-image: linear-gradient(45deg, #8b5a3c, #d4af37, #8b5a3c) 1;
            box-shadow: 0 10px 25px rgba(139, 90, 60, 0.1);
        }
        .musical-accent {
            background: linear-gradient(135deg, #8b5a3c, #d4af37);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .dolce-gold {
            color: #d4af37;
        }
        .dolce-brown {
            color: #8b5a3c;
        }
        .dolce-cream {
            background-color: #faf8f3;
        }
        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(-10px);
        }
        .sync-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }
        .sync-indicator.syncing {
            background: #3b82f6;
            color: white;
        }
        .sync-indicator.success {
            background: #10b981;
            color: white;
        }
        .sync-indicator.error {
            background: #ef4444;
            color: white;
        }
        .ornamental-divider {
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><path d="M0 10 Q25 0 50 10 T100 10" stroke="%23d4af37" stroke-width="2" fill="none"/></svg>') center/contain no-repeat;
            height: 20px;
            margin: 20px 0;
        }
        .contract-header {
            background: linear-gradient(135deg, #8b5a3c 0%, #d4af37 50%, #8b5a3c 100%);
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .clause-border {
            border-left: 4px solid #d4af37;
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.1) 0%, transparent 100%);
        }
        .signature-section {
            background: linear-gradient(135deg, #faf8f3 0%, #f1f0eb 100%);
            border: 2px solid #d4af37;
            border-radius: 15px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Indicador de Sincronizaci√≥n -->
    <div id="syncIndicator" class="sync-indicator">
        <span id="syncText">Sincronizando...</span>
    </div>
    <!-- Pantalla de Login -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-900 to-purple-900">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">üéµ Dolce Ensamble</h1>
                <p class="text-gray-600">Panel de Administraci√≥n</p>
            </div>
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Seleccionar Administrador</label>
                    <select id="adminSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Selecciona tu usuario...</option>
                        <option value="admin1">Administrador 1</option>
                        <option value="admin2">Administrador 2</option>
                        <option value="admin3">Administrador 3</option>
                        <option value="admin4">Administrador 4</option>
                        <option value="admin5">Administrador 5</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a</label>
                    <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ingresa tu contrase√±a">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                    Iniciar Sesi√≥n
                </button>
            </form>
        </div>
    </div>

    <!-- Panel de Administrador -->
    <div id="adminPanel" class="hidden">
        <nav class="bg-white shadow-lg border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <h1 class="text-xl font-bold text-gray-800">üéµ Dolce Ensamble - Panel Admin</h1>
                        <span id="currentAdminName" class="ml-4 text-sm text-gray-600 bg-blue-100 px-3 py-1 rounded-full"></span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button id="newEventBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                            + Nuevo Evento
                        </button>
                        <button id="contractSettingsBtn" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition duration-200">
                            ‚öôÔ∏è Configurar Contrato
                        </button>
                        <button id="historyBtn" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition duration-200">
                            üìä Historial
                        </button>
                        <button id="profileBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                            üë§ Mi Perfil
                        </button>
                        <button id="dataManagementBtn" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition duration-200">
                            üìÅ Gesti√≥n de Datos
                        </button>
                        <button id="logoutBtn" class="text-gray-600 hover:text-gray-800">Cerrar Sesi√≥n</button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- B√∫squeda y Filtros -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <input type="text" id="searchInput" placeholder="Buscar por nombre, tel√©fono o c√≥digo..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Todos los estados</option>
                        <option value="pendiente">Pendiente</option>
                        <option value="firmado">Firmado</option>
                        <option value="completado">Completado</option>
                        <option value="cancelado">Cancelado</option>
                    </select>
                </div>
            </div>

            <!-- Tabla de Eventos -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-800">Eventos y Contratos</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contrato</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Evento</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Creado por</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="eventsTable" class="bg-white divide-y divide-gray-200">
                            <!-- Los eventos se cargar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Perfil de Administrador -->
    <div id="profileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto m-4">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-800">üë§ Mi Perfil</h2>
                <button id="closeProfile" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form id="profileForm" class="p-6 space-y-6">
                <!-- Informaci√≥n Personal -->
                <div class="border-b pb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Informaci√≥n Personal</h3>
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo</label>
                            <input type="text" id="adminName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ID de Usuario</label>
                            <input type="text" id="adminId" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100">
                        </div>
                    </div>
                </div>

                <!-- Cambiar Contrase√±a -->
                <div class="border-b pb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Cambiar Contrase√±a</h3>
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a Actual</label>
                            <input type="password" id="currentPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nueva Contrase√±a</label>
                            <input type="password" id="newPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Confirmar Nueva Contrase√±a</label>
                            <input type="password" id="confirmPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>


                
                <div class="flex justify-end space-x-4 pt-6 border-t">
                    <button type="button" id="cancelProfile" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Historial de Contratos -->
    <div id="historyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-7xl max-h-[90vh] overflow-y-auto m-4">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-800">üìä Historial de Contratos</h2>
                <button id="closeHistory" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="p-6">
                <!-- Filtros del Historial -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Buscar</label>
                            <input type="text" id="historySearch" placeholder="C√≥digo, evento, admin..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Acci√≥n</label>
                            <select id="actionFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Todas las acciones</option>
                                <option value="Contrato creado">Contrato creado</option>
                                <option value="Contrato modificado">Contrato modificado</option>
                                <option value="Contrato firmado">Contrato firmado</option>
                                <option value="Contrato eliminado">Contrato eliminado</option>
                                <option value="Contrato cancelado">Contrato cancelado</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Desde</label>
                            <input type="date" id="dateFrom" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Hasta</label>
                            <input type="date" id="dateTo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button id="filterHistory" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Filtrar
                        </button>
                        <button id="clearHistoryFilters" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                            Limpiar Filtros
                        </button>
                        <button id="exportHistoryBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            üì§ Exportar CSV
                        </button>
                    </div>
                </div>

                <!-- Tabla de Historial -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha/Hora</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acci√≥n</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Administrador</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C√≥digo</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Evento</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Costo</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Versi√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="historyTable" class="bg-white divide-y divide-gray-200">
                            <!-- Los registros se cargar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Exportar Historial -->
    <div id="exportHistoryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-800">üì§ Exportar Historial</h2>
                <button id="closeExportHistory" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Seleccionar Columnas</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" id="exportDate" checked class="mr-2">
                            <span class="text-sm">Fecha/Hora</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="exportAction" checked class="mr-2">
                            <span class="text-sm">Acci√≥n</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="exportAdmin" checked class="mr-2">
                            <span class="text-sm">Administrador</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="exportCode" checked class="mr-2">
                            <span class="text-sm">C√≥digo</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="exportEvent" checked class="mr-2">
                            <span class="text-sm">Evento</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="exportCost" checked class="mr-2">
                            <span class="text-sm">Costo</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="exportVersion" checked class="mr-2">
                            <span class="text-sm">Versi√≥n</span>
                        </label>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Desde</label>
                        <input type="date" id="exportDateFrom" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Hasta</label>
                        <input type="date" id="exportDateTo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="flex justify-end space-x-4 pt-4 border-t">
                    <button id="cancelExportHistory" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button id="confirmExportHistory" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        Exportar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Gesti√≥n de Datos -->
    <div id="dataManagementModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto m-4">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-800">üìÅ Gesti√≥n de Datos</h2>
                <button id="closeDataManagement" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- Exportar/Importar CSV -->
                <div class="border rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">üìÑ Exportar/Importar CSV</h3>
                    <div class="space-y-4">
                        <div>
                            <button id="exportCSV" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                                üì§ Exportar Contratos a CSV
                            </button>
                            <p class="text-sm text-gray-500 mt-2">Descarga todos los contratos en formato CSV</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Importar desde CSV</label>
                            <input type="file" id="importCSV" accept=".csv" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <button id="processImport" class="w-full mt-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                                üì• Procesar Importaci√≥n
                            </button>
                            <p class="text-sm text-gray-500 mt-2">Importa contratos desde un archivo CSV</p>
                        </div>
                    </div>
                </div>

                <!-- Sincronizaci√≥n Firebase -->
                <div class="border rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">üîÑ Sincronizaci√≥n Firebase</h3>
                    <div class="space-y-4">
                        <div>
                            <button id="syncToFirebase" class="w-full bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition duration-200">
                                ‚òÅÔ∏è Sincronizar a Firebase
                            </button>
                            <p class="text-sm text-gray-500 mt-2">Sube todos los datos locales a Firebase</p>
                        </div>
                        <div>
                            <button id="syncFromFirebase" class="w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition duration-200">
                                üì• Obtener de Firebase
                            </button>
                            <p class="text-sm text-gray-500 mt-2">Descarga y actualiza con datos de Firebase</p>
                        </div>
                    </div>
                </div>

                <!-- Eliminar Datos -->
                <div class="border border-red-200 rounded-lg p-4 bg-red-50">
                    <h3 class="text-lg font-semibold text-red-800 mb-4">üóëÔ∏è Eliminar Datos</h3>
                    <div>
                        <button id="deleteAllData" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200">
                            ‚ö†Ô∏è Eliminar Todos los Registros
                        </button>
                        <p class="text-sm text-red-600 mt-2">‚ö†Ô∏è Esta acci√≥n no se puede deshacer</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Confirmaci√≥n Eliminar -->
    <div id="deleteConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4">
            <div class="p-6">
                <div class="flex items-center justify-center w-12 h-12 mx-auto bg-red-100 rounded-full mb-4">
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900 text-center mb-2">¬øEliminar todos los registros?</h3>
                <p class="text-sm text-gray-500 text-center mb-6">Esta acci√≥n eliminar√° permanentemente todos los contratos y no se puede deshacer.</p>
                <div class="flex space-x-4">
                    <button id="cancelDelete" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button id="confirmDelete" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                        Eliminar Todo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Configuraci√≥n del Contrato -->
    <div id="contractSettingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto m-4">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-800">Configuraci√≥n del Contrato</h2>
                <button id="closeContractSettings" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form id="contractSettingsForm" class="p-6 space-y-8">
                <!-- Encabezado y Comparecencia -->
                <div class="border-b pb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">üìã Encabezado y Comparecencia</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nombre de la Empresa</label>
                            <input type="text" id="companyName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nacionalidad</label>
                            <input type="text" id="companyNationality" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">RFC/Identificaci√≥n</label>
                            <input type="text" id="companyId" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mostrar RFC en Contrato</label>
                            <select id="showRFC" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="true">S√≠, mostrar RFC</option>
                                <option value="false">No mostrar RFC</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Lugar del Contrato</label>
                            <input type="text" id="contractPlace" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tel√©fono</label>
                            <input type="tel" id="companyPhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="companyEmail" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- Cl√°usula Primera -->
                <div class="border-b pb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">üéµ Cl√°usula Primera: Objeto del Contrato</h3>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n del Servicio</label>
                        <textarea id="serviceDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                </div>

                <!-- Cl√°usula Segunda -->
                <div class="border-b pb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">üí∞ Cl√°usula Segunda: Pol√≠tica de Pago y Cancelaci√≥n</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pol√≠tica de Pago</label>
                            <textarea id="paymentPolicy" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pol√≠tica de Cancelaci√≥n</label>
                            <textarea id="cancellationPolicy" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Cl√°usula Tercera -->
                <div class="border-b pb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">üéº Cl√°usula Tercera: Repertorio y M√∫sica Adicional</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pol√≠tica de Repertorio</label>
                            <textarea id="repertoirePolicy" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Costo de Canciones Adicionales</label>
                            <textarea id="additionalSongsCost" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Cl√°usula Cuarta -->
                <div class="border-b pb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">üèóÔ∏è Cl√°usula Cuarta: Log√≠stica y Responsabilidades</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Requisitos Log√≠sticos</label>
                            <textarea id="logisticsRequirements" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Responsabilidad del Equipo</label>
                            <textarea id="equipmentResponsibility" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Cl√°usula Quinta -->
                <div class="border-b pb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">‚è∞ Cl√°usula Quinta: Tiempo Extra y Puntualidad</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tiempo de Llegada</label>
                            <textarea id="arrivalTime" rows="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pol√≠tica de Tiempo Extra</label>
                            <textarea id="overtimePolicy" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Cl√°usula Sexta -->
                <div class="border-b pb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">üì∏ Cl√°usula Sexta: Derechos de Imagen y Confidencialidad</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Derechos de Imagen</label>
                            <textarea id="imageRights" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Confidencialidad</label>
                            <textarea id="confidentiality" rows="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Cl√°usula S√©ptima -->
                <div class="border-b pb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">‚öñÔ∏è Cl√°usula S√©ptima: Soluci√≥n de Controversias</h3>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Resoluci√≥n de Disputas</label>
                        <textarea id="disputeResolution" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                </div>

                <!-- Cl√°usula Octava -->
                <div class="border-b pb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">‚úçÔ∏è Cl√°usula Octava: Validez de Firma Digital</h3>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Validez de Firma Digital</label>
                        <textarea id="digitalSignature" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                </div>

                <!-- Gesti√≥n de Firma del Administrador -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">‚úçÔ∏è Mi Firma Digital</h3>
                    <div class="space-y-4">
                        <!-- Firma Actual -->
                        <div id="currentSignatureSection" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Firma Actual</label>
                            <div class="border rounded-lg p-4 bg-gray-50">
                                <img id="currentSignatureImg" src="" alt="Firma actual" class="max-h-20 max-w-48">
                            </div>
                        </div>

                        <!-- Subir Nueva Firma -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Subir Nueva Firma (Imagen)</label>
                            <input type="file" id="signatureUpload" accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <!-- Crear Firma Digital -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">O Crear Firma Digital</label>
                            <canvas id="signatureCanvas" width="400" height="150" class="signature-pad bg-white rounded-lg w-full border"></canvas>
                            <div class="flex gap-2 mt-2">
                                <button type="button" id="clearSignatureCanvas" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                                    Limpiar
                                </button>
                                <button type="button" id="saveCanvasSignature" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    Usar Esta Firma
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-4 pt-6 border-t">
                    <button type="button" id="cancelContractSettings" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                        Guardar Configuraci√≥n
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Nuevo/Editar Evento -->
    <div id="eventModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto m-4">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h2 id="modalTitle" class="text-xl font-semibold text-gray-800">Nuevo Evento</h2>
                <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form id="eventForm" class="p-6 space-y-6">
                <input type="hidden" id="editingEventId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre del Cliente *</label>
                        <input type="text" id="clientName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tel√©fono *</label>
                        <input type="tel" id="clientPhone" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="clientEmail" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Evento *</label>
                        <input type="text" id="eventType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Ej. Boda, XV A√±os, Cumplea√±os, Evento Corporativo...">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Fecha del Evento *</label>
                        <input type="date" id="eventDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Hora de Inicio *</label>
                        <input type="time" id="eventTime" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lugar del Evento *</label>
                        <input type="text" id="eventLocation" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Duraci√≥n (horas) *</label>
                        <input type="number" id="eventDuration" required min="1" max="12" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Precio Total *</label>
                        <input type="number" id="eventPrice" required min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Anticipo Recibido</label>
                        <input type="number" id="advancePayment" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Ej. 2000">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Estado del Contrato</label>
                        <select id="contractStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="pendiente">Pendiente</option>
                            <option value="firmado">Firmado</option>
                            <option value="completado">Completado</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Versi√≥n del Contrato</label>
                        <select id="contractVersion" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="1">Versi√≥n 1.0</option>
                            <option value="2">Versi√≥n 2.0</option>
                            <option value="3">Versi√≥n 3.0</option>
                            <option value="4">Versi√≥n 4.0</option>
                            <option value="5">Versi√≥n 5.0</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Servicios Incluidos</label>
                        <textarea id="eventServices" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Describe los servicios incluidos..."></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">T√©rminos y Condiciones Adicionales</label>
                        <textarea id="eventTerms" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="T√©rminos espec√≠ficos del contrato..."></textarea>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-4 pt-6 border-t">
                    <button type="button" id="cancelBtn" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Guardar Evento
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Pantalla de √âxito con Enlace -->
    <div id="successScreen" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4 p-6">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                    <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">¬°Evento Creado Exitosamente!</h3>
                <p class="text-sm text-gray-500 mb-6">Comparte este enlace con tu cliente para que pueda ver y firmar el contrato:</p>
                
                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                    <p class="text-xs text-gray-500 mb-2">Enlace del contrato:</p>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="contractLink" readonly class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded bg-white">
                        <button id="copyLinkBtn" class="px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                            Copiar
                        </button>
                    </div>
                </div>
                
                <button id="closeSuccessBtn" class="w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Vista del Cliente -->
    <div id="clientView" class="hidden min-h-screen bg-gray-100">
        <div class="max-w-4xl mx-auto py-8 px-4">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6">
                    <h1 class="text-2xl font-bold">üéµ Dolce Ensamble</h1>
                    <p class="text-blue-100">Contrato de Servicios Musicales</p>
                </div>
                
                <div id="contractContent" class="contract-bg p-8">
                    <!-- El contenido del contrato se generar√° aqu√≠ -->
                </div>
                
                <div id="signatureSection" class="p-6 border-t bg-gray-50">
                    <h3 class="text-lg font-semibold mb-4">Firma del Cliente</h3>
                    <div class="mb-4">
                        <canvas id="signaturePad" width="600" height="200" class="signature-pad bg-white rounded-lg w-full max-w-2xl"></canvas>
                    </div>
                    <div class="flex flex-wrap gap-4">
                        <button id="clearSignature" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                            Limpiar Firma
                        </button>
                        <button id="saveSignature" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            Guardar Firma
                        </button>
                        <button id="downloadPDF" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Descargar PDF
                        </button>
                        <button id="contactAdmin" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            Contactar Administrador
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentUser = null;
        let currentContract = null;
        let isDrawing = false;
        let signatureData = null;
        let administrators = {
            admin1: { name: 'Administrador 1', password: '123', signature: null },
            admin2: { name: 'Administrador 2', password: '123', signature: null },
            admin3: { name: 'Administrador 3', password: '123', signature: null },
            admin4: { name: 'Administrador 4', password: '123', signature: null },
            admin5: { name: 'Administrador 5', password: '123', signature: null }
        };
        let contractSettings = {
            // Encabezado y Comparecencia
            companyName: 'DOLCE ENSAMBLE',
            companyNationality: 'Mexicana',
            companyId: 'RFC: XAXX010101000',
            companyPhone: '+52 811 047 4854',
            companyEmail: 'contacto@dolceensamble.com',
            contractPlace: 'Monterrey, Nuevo Le√≥n',
            showRFC: 'false',
            
            // Cl√°usula Primera: Objeto del Contrato
            serviceDescription: 'Prestaci√≥n de servicios musicales profesionales con ensamble en vivo para evento social/corporativo, incluyendo interpretaci√≥n musical, equipo de sonido profesional y ambientaci√≥n musical seg√∫n cotizaci√≥n anexa.',
            
            // Cl√°usula Segunda: Pol√≠tica de Pago y Cancelaci√≥n
            paymentPolicy: '50% de anticipo para apartar la fecha al momento de la firma del contrato, 50% restante el d√≠a del evento antes del inicio del servicio.',
            cancellationPolicy: 'En caso de cancelaci√≥n por parte de EL CONTRATANTE con menos de 15 d√≠as de anticipaci√≥n, no se reembolsar√° el anticipo. Con m√°s de 15 d√≠as, se reembolsar√° el 80% del anticipo.',
            
            // Cl√°usula Tercera: Repertorio y M√∫sica Adicional
            repertoirePolicy: 'EL PRESTADOR cuenta con un repertorio base de m√°s de 200 canciones en diversos g√©neros. EL CONTRATANTE podr√° solicitar hasta 5 canciones espec√≠ficas sin costo adicional, siempre que se notifique con al menos 7 d√≠as de anticipaci√≥n.',
            additionalSongsCost: 'Canciones adicionales fuera del repertorio base tendr√°n un costo de $500 MXN por canci√≥n, sujeto a disponibilidad y complejidad musical.',
            
            // Cl√°usula Cuarta: Log√≠stica y Responsabilidades
            logisticsRequirements: 'EL CONTRATANTE deber√° proporcionar: espacio adecuado para el ensamble (m√≠nimo 3x4 metros), acceso a energ√≠a el√©ctrica (2 contactos de 110V), √°rea techada en caso de evento al aire libre, estacionamiento para el equipo, y alimentaci√≥n para los m√∫sicos en eventos de m√°s de 4 horas.',
            equipmentResponsibility: 'EL CONTRATANTE ser√° responsable de cualquier da√±o al equipo musical causado por terceros o condiciones del lugar no informadas previamente.',
            
            // Cl√°usula Quinta: Tiempo Extra y Puntualidad
            arrivalTime: 'EL PRESTADOR llegar√° 60 minutos antes del inicio del evento para montaje y pruebas de sonido.',
            overtimePolicy: 'Tiempo adicional al contratado tendr√° un costo de $800 MXN por cada 30 minutos o fracci√≥n, sujeto a disponibilidad del ensamble.',
            
            // Cl√°usula Sexta: Derechos de Imagen
            imageRights: 'EL CONTRATANTE otorga permiso a EL PRESTADOR para utilizar material audiovisual del evento con fines promocionales y de portafolio, salvo notificaci√≥n expresa en contrario por escrito.',
            confidentiality: 'Ambas partes se comprometen a mantener confidencialidad sobre informaci√≥n personal y detalles privados del evento.',
            
            // Cl√°usula S√©ptima: Soluci√≥n de Controversias
            disputeResolution: 'Las controversias se resolver√°n mediante mediaci√≥n. En caso de no llegar a acuerdo, se someter√°n a la jurisdicci√≥n de los tribunales competentes de Monterrey, Nuevo Le√≥n, M√©xico.',
            
            // Cl√°usula Octava: Validez de Firma Digital
            digitalSignature: 'Las partes reconocen la validez legal de la firma electr√≥nica conforme a la legislaci√≥n mexicana vigente, teniendo el mismo valor probatorio que la firma aut√≥grafa.'
        };

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            checkURLParams();
            setupEventListeners();
            loadAdministrators();
            loadContractSettings();
        });

        function checkURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const contractId = urlParams.get('contract');
            
            if (contractId) {
                showClientView(contractId);
            } else {
                showLoginScreen();
            }
        }

        function setupEventListeners() {
            // Login
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Admin Panel
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('newEventBtn').addEventListener('click', () => openEventModal());
            document.getElementById('contractSettingsBtn').addEventListener('click', openContractSettings);
            document.getElementById('historyBtn').addEventListener('click', openHistory);
            document.getElementById('profileBtn').addEventListener('click', openProfile);
            document.getElementById('dataManagementBtn').addEventListener('click', openDataManagement);
            document.getElementById('closeModal').addEventListener('click', closeEventModal);
            document.getElementById('cancelBtn').addEventListener('click', closeEventModal);
            document.getElementById('eventForm').addEventListener('submit', handleEventSubmit);
            
            // Profile
            document.getElementById('closeProfile').addEventListener('click', closeProfile);
            document.getElementById('cancelProfile').addEventListener('click', closeProfile);
            document.getElementById('profileForm').addEventListener('submit', handleProfileSubmit);
            
            // History
            document.getElementById('closeHistory').addEventListener('click', closeHistory);
            document.getElementById('filterHistory').addEventListener('click', filterHistory);
            document.getElementById('clearHistoryFilters').addEventListener('click', clearHistoryFilters);
            document.getElementById('exportHistoryBtn').addEventListener('click', openExportHistory);
            
            // Export History
            document.getElementById('closeExportHistory').addEventListener('click', closeExportHistory);
            document.getElementById('cancelExportHistory').addEventListener('click', closeExportHistory);
            document.getElementById('confirmExportHistory').addEventListener('click', exportHistory);
            
            // Contract Settings
            document.getElementById('closeContractSettings').addEventListener('click', closeContractSettings);
            document.getElementById('cancelContractSettings').addEventListener('click', closeContractSettings);
            document.getElementById('contractSettingsForm').addEventListener('submit', handleContractSettingsSubmit);
            document.getElementById('signatureUpload').addEventListener('change', handleSignatureUpload);
            document.getElementById('clearSignatureCanvas').addEventListener('click', clearSignatureCanvas);
            document.getElementById('saveCanvasSignature').addEventListener('click', saveCanvasSignature);
            
            // Data Management
            document.getElementById('closeDataManagement').addEventListener('click', closeDataManagement);
            document.getElementById('exportCSV').addEventListener('click', exportToCSV);
            document.getElementById('processImport').addEventListener('click', importFromCSV);
            document.getElementById('syncToFirebase').addEventListener('click', syncToFirebase);
            document.getElementById('syncFromFirebase').addEventListener('click', syncFromFirebase);
            document.getElementById('deleteAllData').addEventListener('click', showDeleteConfirmation);
            document.getElementById('cancelDelete').addEventListener('click', hideDeleteConfirmation);
            document.getElementById('confirmDelete').addEventListener('click', deleteAllData);
            
            // B√∫squeda
            document.getElementById('searchInput').addEventListener('input', filterEvents);
            document.getElementById('statusFilter').addEventListener('change', filterEvents);
            
            // Success Screen
            document.getElementById('copyLinkBtn').addEventListener('click', copyContractLink);
            document.getElementById('closeSuccessBtn').addEventListener('click', closeSuccessScreen);
            
            // Cliente
            setupSignaturePad();
            document.getElementById('clearSignature').addEventListener('click', clearSignature);
            document.getElementById('saveSignature').addEventListener('click', saveSignature);
            document.getElementById('downloadPDF').addEventListener('click', downloadContractPDF);
            document.getElementById('contactAdmin').addEventListener('click', contactAdmin);
            
            // Setup signature canvas for profile
            setupProfileSignatureCanvas();
        }

        // Indicador de sincronizaci√≥n
        function showSyncIndicator(type, message) {
            const indicator = document.getElementById('syncIndicator');
            const text = document.getElementById('syncText');
            
            indicator.className = `sync-indicator show ${type}`;
            text.textContent = message;
            
            setTimeout(() => {
                indicator.classList.remove('show');
            }, type === 'syncing' ? 0 : 3000);
        }

        // Gesti√≥n de administradores con sincronizaci√≥n Firebase
        async function loadAdministrators() {
            try {
                showSyncIndicator('syncing', 'üîÑ Cargando perfiles...');
                const docRef = window.firestore.doc(window.db, 'settings', 'administrators');
                const docSnap = await window.firestore.getDoc(docRef);
                
                if (docSnap.exists()) {
                    const firebaseData = docSnap.data();
                    // Mantener las contrase√±as por defecto si no existen en Firebase
                    Object.keys(administrators).forEach(adminId => {
                        if (firebaseData[adminId]) {
                            administrators[adminId] = {
                                ...administrators[adminId],
                                ...firebaseData[adminId]
                            };
                        }
                    });
                }
                showSyncIndicator('success', '‚úÖ Perfiles actualizados');
            } catch (error) {
                console.error('Error al cargar administradores:', error);
                showSyncIndicator('error', '‚ùå Error al cargar perfiles');
            }
        }

        async function saveAdministrators() {
            try {
                showSyncIndicator('syncing', 'üîÑ Guardando perfil...');
                const docRef = window.firestore.doc(window.db, 'settings', 'administrators');
                
                try {
                    await window.firestore.updateDoc(docRef, administrators);
                } catch (updateError) {
                    // Si el documento no existe, lo creamos
                    await window.firestore.setDoc(docRef, administrators);
                }
                
                showSyncIndicator('success', '‚úÖ Perfil guardado');
            } catch (error) {
                console.error('Error al guardar administradores:', error);
                showSyncIndicator('error', '‚ùå Error al guardar perfil');
                throw error;
            }
        }

        // Perfil de administrador
        function openProfile() {
            document.getElementById('profileModal').classList.remove('hidden');
            fillProfileForm();
        }

        function closeProfile() {
            document.getElementById('profileModal').classList.add('hidden');
        }

        function fillProfileForm() {
            const admin = administrators[currentUser];
            document.getElementById('adminName').value = admin.name;
            document.getElementById('adminId').value = currentUser;
            
            // Limpiar campos de contrase√±a
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        async function handleProfileSubmit(e) {
            e.preventDefault();
            
            const adminName = document.getElementById('adminName').value;
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validar contrase√±a actual si se quiere cambiar
            if (newPassword) {
                if (currentPassword !== administrators[currentUser].password) {
                    alert('La contrase√±a actual es incorrecta');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    alert('Las contrase√±as nuevas no coinciden');
                    return;
                }
                
                if (newPassword.length < 3) {
                    alert('La nueva contrase√±a debe tener al menos 3 caracteres');
                    return;
                }
            }
            
            // Actualizar datos del administrador
            administrators[currentUser].name = adminName;
            if (newPassword) {
                administrators[currentUser].password = newPassword;
            }
            
            try {
                await saveAdministrators();
                document.getElementById('currentAdminName').textContent = adminName;
                closeProfile();
                alert('Perfil actualizado exitosamente');
            } catch (error) {
                console.error('Error al actualizar perfil:', error);
                alert('Error al actualizar el perfil');
            }
        }

        function handleSignatureUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    administrators[currentUser].signature = event.target.result;
                    document.getElementById('currentSignatureSection').classList.remove('hidden');
                    document.getElementById('currentSignatureImg').src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function setupProfileSignatureCanvas() {
            const canvas = document.getElementById('signatureCanvas');
            const ctx = canvas.getContext('2d');
            let isDrawing = false;
            
            // Configurar canvas
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            
            // Eventos de mouse
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Eventos t√°ctiles
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
            
            function startDrawing(e) {
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                ctx.beginPath();
                ctx.moveTo(x, y);
            }
            
            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                ctx.lineTo(x, y);
                ctx.stroke();
            }
            
            function stopDrawing() {
                isDrawing = false;
            }
            
            function handleTouch(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                                 e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }
        }

        function clearSignatureCanvas() {
            const canvas = document.getElementById('signatureCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function saveCanvasSignature() {
            const canvas = document.getElementById('signatureCanvas');
            const signatureData = canvas.toDataURL();
            
            administrators[currentUser].signature = signatureData;
            document.getElementById('currentSignatureSection').classList.remove('hidden');
            document.getElementById('currentSignatureImg').src = signatureData;
            
            alert('Firma guardada. Recuerda guardar los cambios del perfil.');
        }

        // Historial de contratos
        function openHistory() {
            document.getElementById('historyModal').classList.remove('hidden');
            loadHistory();
        }

        function closeHistory() {
            document.getElementById('historyModal').classList.add('hidden');
        }

        async function loadHistory() {
            try {
                const q = window.firestore.query(
                    window.firestore.collection(window.db, 'contract_history'),
                    window.firestore.orderBy('timestamp', 'desc')
                );
                const querySnapshot = await window.firestore.getDocs(q);
                
                const history = [];
                querySnapshot.forEach((doc) => {
                    history.push({ id: doc.id, ...doc.data() });
                });
                
                displayHistory(history);
            } catch (error) {
                console.error('Error al cargar historial:', error);
            }
        }

        function displayHistory(history) {
            const tbody = document.getElementById('historyTable');
            tbody.innerHTML = '';
            
            history.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-900">
                        ${new Date(record.timestamp).toLocaleString('es-ES')}
                    </td>
                    <td class="px-4 py-3 text-sm">
                        <span class="px-2 py-1 text-xs rounded-full ${getActionColor(record.action)}">
                            ${record.action}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-900">${record.adminName}</td>
                    <td class="px-4 py-3 text-sm font-mono text-blue-600">${record.contractCode}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${record.eventName || '-'}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">
                        ${record.cost ? '$' + parseFloat(record.cost).toLocaleString('es-MX') : '-'}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-900">${record.version || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function getActionColor(action) {
            switch(action) {
                case 'Contrato creado': return 'bg-green-100 text-green-800';
                case 'Contrato modificado': return 'bg-blue-100 text-blue-800';
                case 'Contrato firmado': return 'bg-purple-100 text-purple-800';
                case 'Contrato eliminado': return 'bg-red-100 text-red-800';
                case 'Contrato cancelado': return 'bg-yellow-100 text-yellow-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        async function addToHistory(action, contractId, contractData = {}) {
            try {
                const historyRecord = {
                    action: action,
                    adminId: currentUser,
                    adminName: administrators[currentUser].name,
                    contractId: contractId,
                    contractCode: contractId.substring(0, 8).toUpperCase(),
                    eventName: contractData.eventType || null,
                    cost: contractData.eventPrice || null,
                    version: contractData.contractVersion || null,
                    timestamp: new Date().toISOString()
                };
                
                await window.firestore.addDoc(window.firestore.collection(window.db, 'contract_history'), historyRecord);
            } catch (error) {
                console.error('Error al agregar al historial:', error);
            }
        }

        function filterHistory() {
            // Implementar filtrado del historial
            loadHistory();
        }

        function clearHistoryFilters() {
            document.getElementById('historySearch').value = '';
            document.getElementById('actionFilter').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            loadHistory();
        }

        function openExportHistory() {
            document.getElementById('exportHistoryModal').classList.remove('hidden');
        }

        function closeExportHistory() {
            document.getElementById('exportHistoryModal').classList.add('hidden');
        }

        async function exportHistory() {
            try {
                // Obtener configuraci√≥n de exportaci√≥n
                const columns = {
                    date: document.getElementById('exportDate').checked,
                    action: document.getElementById('exportAction').checked,
                    admin: document.getElementById('exportAdmin').checked,
                    code: document.getElementById('exportCode').checked,
                    event: document.getElementById('exportEvent').checked,
                    cost: document.getElementById('exportCost').checked,
                    version: document.getElementById('exportVersion').checked
                };
                
                const dateFrom = document.getElementById('exportDateFrom').value;
                const dateTo = document.getElementById('exportDateTo').value;
                
                // Obtener datos del historial
                let q = window.firestore.query(
                    window.firestore.collection(window.db, 'contract_history'),
                    window.firestore.orderBy('timestamp', 'desc')
                );
                
                const querySnapshot = await window.firestore.getDocs(q);
                let history = [];
                querySnapshot.forEach((doc) => {
                    history.push({ id: doc.id, ...doc.data() });
                });
                
                // Filtrar por fechas si se especificaron
                if (dateFrom || dateTo) {
                    history = history.filter(record => {
                        const recordDate = new Date(record.timestamp).toISOString().split('T')[0];
                        if (dateFrom && recordDate < dateFrom) return false;
                        if (dateTo && recordDate > dateTo) return false;
                        return true;
                    });
                }
                
                if (history.length === 0) {
                    alert('No hay registros para exportar con los filtros seleccionados');
                    return;
                }
                
                // Crear CSV
                const headers = [];
                if (columns.date) headers.push('Fecha/Hora');
                if (columns.action) headers.push('Acci√≥n');
                if (columns.admin) headers.push('Administrador');
                if (columns.code) headers.push('C√≥digo');
                if (columns.event) headers.push('Evento');
                if (columns.cost) headers.push('Costo');
                if (columns.version) headers.push('Versi√≥n');
                
                const csvContent = [
                    headers.join(','),
                    ...history.map(record => {
                        const row = [];
                        if (columns.date) row.push(`"${new Date(record.timestamp).toLocaleString('es-ES')}"`);
                        if (columns.action) row.push(`"${record.action}"`);
                        if (columns.admin) row.push(`"${record.adminName}"`);
                        if (columns.code) row.push(record.contractCode);
                        if (columns.event) row.push(`"${record.eventName || ''}"`);
                        if (columns.cost) row.push(record.cost || '');
                        if (columns.version) row.push(record.version || '');
                        return row.join(',');
                    })
                ].join('\n');
                
                // Descargar archivo
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `historial_contratos_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                closeExportHistory();
                alert('Historial exportado exitosamente');
            } catch (error) {
                console.error('Error al exportar historial:', error);
                alert('Error al exportar el historial');
            }
        }

        // Gesti√≥n de datos
        function openDataManagement() {
            document.getElementById('dataManagementModal').classList.remove('hidden');
        }

        function closeDataManagement() {
            document.getElementById('dataManagementModal').classList.add('hidden');
        }

        async function exportToCSV() {
            try {
                const q = window.firestore.query(
                    window.firestore.collection(window.db, 'contracts'),
                    window.firestore.orderBy('createdAt', 'desc')
                );
                const querySnapshot = await window.firestore.getDocs(q);
                
                const contracts = [];
                querySnapshot.forEach((doc) => {
                    contracts.push({ id: doc.id, ...doc.data() });
                });

                if (contracts.length === 0) {
                    alert('No hay contratos para exportar');
                    return;
                }

                // Crear CSV
                const headers = [
                    'ID', 'Cliente', 'Tel√©fono', 'Email', 'Tipo Evento', 'Fecha Evento', 
                    'Hora', 'Lugar', 'Duraci√≥n', 'Precio', 'Estado', 'Servicios', 
                    'T√©rminos', 'Fecha Creaci√≥n', 'Firmado', 'Creado por', 'Versi√≥n'
                ];

                const csvContent = [
                    headers.join(','),
                    ...contracts.map(contract => [
                        contract.id,
                        `"${contract.clientName || ''}"`,
                        contract.clientPhone || '',
                        contract.clientEmail || '',
                        contract.eventType || '',
                        contract.eventDate || '',
                        contract.eventTime || '',
                        `"${contract.eventLocation || ''}"`,
                        contract.eventDuration || '',
                        contract.eventPrice || '',
                        contract.status || '',
                        `"${(contract.eventServices || '').replace(/"/g, '""')}"`,
                        `"${(contract.eventTerms || '').replace(/"/g, '""')}"`,
                        contract.createdAt || '',
                        contract.clientSignature ? 'S√≠' : 'No',
                        contract.createdBy || '',
                        contract.contractVersion || ''
                    ].join(','))
                ].join('\n');

                // Descargar archivo
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `contratos_dolce_ensamble_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                alert('Archivo CSV exportado exitosamente');
            } catch (error) {
                console.error('Error al exportar CSV:', error);
                alert('Error al exportar los datos');
            }
        }

        async function importFromCSV() {
            const fileInput = document.getElementById('importCSV');
            const file = fileInput.files[0];

            if (!file) {
                alert('Por favor selecciona un archivo CSV');
                return;
            }

            try {
                const text = await file.text();
                const lines = text.split('\n');
                const headers = lines[0].split(',');

                if (lines.length < 2) {
                    alert('El archivo CSV est√° vac√≠o o no tiene datos');
                    return;
                }

                let importedCount = 0;
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    const values = line.split(',');
                    if (values.length < headers.length) continue;

                    const contractData = {
                        clientName: values[1].replace(/"/g, ''),
                        clientPhone: values[2],
                        clientEmail: values[3],
                        eventType: values[4],
                        eventDate: values[5],
                        eventTime: values[6],
                        eventLocation: values[7].replace(/"/g, ''),
                        eventDuration: values[8],
                        eventPrice: values[9],
                        status: values[10] || 'pendiente',
                        eventServices: values[11].replace(/"/g, ''),
                        eventTerms: values[12].replace(/"/g, ''),
                        createdAt: values[13] || new Date().toISOString(),
                        contractVersion: parseInt(values[16]) || 1,
                        createdBy: currentUser,
                        adminSignature: administrators[currentUser].signature
                    };

                    const docRef = await window.firestore.addDoc(window.firestore.collection(window.db, 'contracts'), contractData);
                    await addToHistory('Contrato creado', docRef.id, contractData);
                    importedCount++;
                }

                alert(`Se importaron ${importedCount} contratos exitosamente`);
                loadEvents();
                fileInput.value = '';
            } catch (error) {
                console.error('Error al importar CSV:', error);
                alert('Error al importar el archivo CSV');
            }
        }

        async function syncToFirebase() {
            try {
                alert('Los datos ya est√°n sincronizados con Firebase autom√°ticamente');
            } catch (error) {
                console.error('Error al sincronizar:', error);
                alert('Error al sincronizar con Firebase');
            }
        }

        async function syncFromFirebase() {
            try {
                await loadEvents();
                await loadContractSettings();
                await loadAdministrators();
                alert('Datos actualizados desde Firebase exitosamente');
            } catch (error) {
                console.error('Error al obtener datos:', error);
                alert('Error al obtener datos de Firebase');
            }
        }

        function showDeleteConfirmation() {
            document.getElementById('deleteConfirmModal').classList.remove('hidden');
        }

        function hideDeleteConfirmation() {
            document.getElementById('deleteConfirmModal').classList.add('hidden');
        }

        async function deleteAllData() {
            try {
                const q = window.firestore.query(window.firestore.collection(window.db, 'contracts'));
                const querySnapshot = await window.firestore.getDocs(q);
                
                const deletePromises = [];
                querySnapshot.forEach((doc) => {
                    deletePromises.push(window.firestore.deleteDoc(doc.ref));
                });

                await Promise.all(deletePromises);
                
                // Tambi√©n eliminar historial
                const historyQ = window.firestore.query(window.firestore.collection(window.db, 'contract_history'));
                const historySnapshot = await window.firestore.getDocs(historyQ);
                
                const historyDeletePromises = [];
                historySnapshot.forEach((doc) => {
                    historyDeletePromises.push(window.firestore.deleteDoc(doc.ref));
                });

                await Promise.all(historyDeletePromises);
                
                hideDeleteConfirmation();
                closeDataManagement();
                loadEvents();
                alert('Todos los registros han sido eliminados');
            } catch (error) {
                console.error('Error al eliminar datos:', error);
                alert('Error al eliminar los registros');
            }
        }

        // Configuraci√≥n del contrato
        function openContractSettings() {
            document.getElementById('contractSettingsModal').classList.remove('hidden');
            fillContractSettingsForm();
        }

        function closeContractSettings() {
            document.getElementById('contractSettingsModal').classList.add('hidden');
        }

        function fillContractSettingsForm() {
            // Encabezado y Comparecencia
            document.getElementById('companyName').value = contractSettings.companyName;
            document.getElementById('companyNationality').value = contractSettings.companyNationality;
            document.getElementById('companyId').value = contractSettings.companyId;
            document.getElementById('companyPhone').value = contractSettings.companyPhone;
            document.getElementById('companyEmail').value = contractSettings.companyEmail;
            document.getElementById('contractPlace').value = contractSettings.contractPlace;
            document.getElementById('showRFC').value = contractSettings.showRFC;
            
            // Cl√°usulas
            document.getElementById('serviceDescription').value = contractSettings.serviceDescription;
            document.getElementById('paymentPolicy').value = contractSettings.paymentPolicy;
            document.getElementById('cancellationPolicy').value = contractSettings.cancellationPolicy;
            document.getElementById('repertoirePolicy').value = contractSettings.repertoirePolicy;
            document.getElementById('additionalSongsCost').value = contractSettings.additionalSongsCost;
            document.getElementById('logisticsRequirements').value = contractSettings.logisticsRequirements;
            document.getElementById('equipmentResponsibility').value = contractSettings.equipmentResponsibility;
            document.getElementById('arrivalTime').value = contractSettings.arrivalTime;
            document.getElementById('overtimePolicy').value = contractSettings.overtimePolicy;
            document.getElementById('imageRights').value = contractSettings.imageRights;
            document.getElementById('confidentiality').value = contractSettings.confidentiality;
            document.getElementById('disputeResolution').value = contractSettings.disputeResolution;
            document.getElementById('digitalSignature').value = contractSettings.digitalSignature;
            
            // Mostrar firma actual del administrador
            const admin = administrators[currentUser];
            if (admin && admin.signature) {
                document.getElementById('currentSignatureSection').classList.remove('hidden');
                document.getElementById('currentSignatureImg').src = admin.signature;
            } else {
                document.getElementById('currentSignatureSection').classList.add('hidden');
            }
        }

        async function handleContractSettingsSubmit(e) {
            e.preventDefault();
            
            contractSettings = {
                // Encabezado y Comparecencia
                companyName: document.getElementById('companyName').value,
                companyNationality: document.getElementById('companyNationality').value,
                companyId: document.getElementById('companyId').value,
                companyPhone: document.getElementById('companyPhone').value,
                companyEmail: document.getElementById('companyEmail').value,
                contractPlace: document.getElementById('contractPlace').value,
                showRFC: document.getElementById('showRFC').value,
                
                // Cl√°usulas
                serviceDescription: document.getElementById('serviceDescription').value,
                paymentPolicy: document.getElementById('paymentPolicy').value,
                cancellationPolicy: document.getElementById('cancellationPolicy').value,
                repertoirePolicy: document.getElementById('repertoirePolicy').value,
                additionalSongsCost: document.getElementById('additionalSongsCost').value,
                logisticsRequirements: document.getElementById('logisticsRequirements').value,
                equipmentResponsibility: document.getElementById('equipmentResponsibility').value,
                arrivalTime: document.getElementById('arrivalTime').value,
                overtimePolicy: document.getElementById('overtimePolicy').value,
                imageRights: document.getElementById('imageRights').value,
                confidentiality: document.getElementById('confidentiality').value,
                disputeResolution: document.getElementById('disputeResolution').value,
                digitalSignature: document.getElementById('digitalSignature').value
            };

            try {
                await saveContractSettings();
                await saveAdministrators(); // Guardar tambi√©n los cambios de firma del administrador
                closeContractSettings();
                alert('Configuraci√≥n y firma guardadas exitosamente');
            } catch (error) {
                console.error('Error al guardar configuraci√≥n:', error);
                alert('Error al guardar la configuraci√≥n');
            }
        }

        async function loadContractSettings() {
            try {
                showSyncIndicator('syncing', 'üîÑ Cargando configuraci√≥n...');
                const docRef = window.firestore.doc(window.db, 'settings', 'contract');
                const docSnap = await window.firestore.getDoc(docRef);
                
                if (docSnap.exists()) {
                    contractSettings = { ...contractSettings, ...docSnap.data() };
                }
                showSyncIndicator('success', '‚úÖ Configuraci√≥n cargada');
            } catch (error) {
                console.error('Error al cargar configuraci√≥n:', error);
                showSyncIndicator('error', '‚ùå Error al cargar configuraci√≥n');
            }
        }

        async function saveContractSettings() {
            try {
                showSyncIndicator('syncing', 'üîÑ Guardando configuraci√≥n...');
                const docRef = window.firestore.doc(window.db, 'settings', 'contract');
                
                try {
                    await window.firestore.updateDoc(docRef, contractSettings);
                } catch (updateError) {
                    // Si el documento no existe, lo creamos
                    await window.firestore.setDoc(docRef, contractSettings);
                }
                
                showSyncIndicator('success', '‚úÖ Configuraci√≥n guardada');
            } catch (error) {
                console.error('Error al guardar configuraci√≥n:', error);
                showSyncIndicator('error', '‚ùå Error al guardar configuraci√≥n');
                throw error;
            }
        }

        // Autenticaci√≥n
        async function handleLogin(e) {
            e.preventDefault();
            const selectedAdmin = document.getElementById('adminSelect').value;
            const password = document.getElementById('password').value;
            
            if (!selectedAdmin) {
                alert('Por favor selecciona un administrador');
                return;
            }
            
            await loadAdministrators(); // Cargar datos m√°s recientes
            
            if (administrators[selectedAdmin] && administrators[selectedAdmin].password === password) {
                currentUser = selectedAdmin;
                showAdminPanel();
                document.getElementById('currentAdminName').textContent = administrators[selectedAdmin].name;
                loadEvents();
            } else {
                alert('Contrase√±a incorrecta');
            }
        }

        function logout() {
            currentUser = null;
            showLoginScreen();
            document.getElementById('loginForm').reset();
        }

        // Navegaci√≥n entre pantallas
        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('clientView').classList.add('hidden');
        }

        function showAdminPanel() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
            document.getElementById('clientView').classList.add('hidden');
        }

        function showClientView(contractId) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('clientView').classList.remove('hidden');
            loadContract(contractId);
        }

        // Gesti√≥n de eventos
        function openEventModal(eventData = null) {
            document.getElementById('eventModal').classList.remove('hidden');
            document.getElementById('modalTitle').textContent = eventData ? 'Editar Evento' : 'Nuevo Evento';
            
            if (eventData) {
                fillEventForm(eventData);
            } else {
                document.getElementById('eventForm').reset();
                document.getElementById('contractStatus').value = 'pendiente';
                document.getElementById('contractVersion').value = '1';
            }
        }

        function closeEventModal() {
            document.getElementById('eventModal').classList.add('hidden');
            document.getElementById('eventForm').reset();
            document.getElementById('editingEventId').value = '';
        }

        function fillEventForm(eventData) {
            document.getElementById('editingEventId').value = eventData.id || '';
            document.getElementById('clientName').value = eventData.clientName || '';
            document.getElementById('clientPhone').value = eventData.clientPhone || '';
            document.getElementById('clientEmail').value = eventData.clientEmail || '';
            document.getElementById('eventType').value = eventData.eventType || '';
            document.getElementById('eventDate').value = eventData.eventDate || '';
            document.getElementById('eventTime').value = eventData.eventTime || '';
            document.getElementById('eventLocation').value = eventData.eventLocation || '';
            document.getElementById('eventDuration').value = eventData.eventDuration || '';
            document.getElementById('eventPrice').value = eventData.eventPrice || '';
            document.getElementById('advancePayment').value = eventData.advancePayment || '';
            document.getElementById('contractStatus').value = eventData.status || 'pendiente';
            document.getElementById('contractVersion').value = eventData.contractVersion || '1';
            document.getElementById('eventServices').value = eventData.eventServices || '';
            document.getElementById('eventTerms').value = eventData.eventTerms || '';
        }

        async function handleEventSubmit(e) {
            e.preventDefault();
            
            const eventData = {
                clientName: document.getElementById('clientName').value,
                clientPhone: document.getElementById('clientPhone').value,
                clientEmail: document.getElementById('clientEmail').value,
                eventType: document.getElementById('eventType').value,
                eventDate: document.getElementById('eventDate').value,
                eventTime: document.getElementById('eventTime').value,
                eventLocation: document.getElementById('eventLocation').value,
                eventDuration: document.getElementById('eventDuration').value,
                eventPrice: document.getElementById('eventPrice').value,
                advancePayment: document.getElementById('advancePayment').value || 0,
                status: document.getElementById('contractStatus').value,
                contractVersion: parseInt(document.getElementById('contractVersion').value),
                eventServices: document.getElementById('eventServices').value,
                eventTerms: document.getElementById('eventTerms').value,
                createdBy: currentUser,
                adminSignature: administrators[currentUser].signature
            };

            const editingId = document.getElementById('editingEventId').value;

            try {
                if (editingId) {
                    // Actualizar evento existente
                    showSyncIndicator('syncing', 'üîÑ Actualizando contrato...');
                    const docRef = window.firestore.doc(window.db, 'contracts', editingId);
                    await window.firestore.updateDoc(docRef, {
                        ...eventData,
                        updatedAt: new Date().toISOString()
                    });
                    await addToHistory('Contrato modificado', editingId, eventData);
                    closeEventModal();
                    loadEvents();
                    showSyncIndicator('success', '‚úÖ Contrato actualizado');
                } else {
                    // Crear nuevo evento
                    showSyncIndicator('syncing', 'üîÑ Creando contrato...');
                    eventData.createdAt = new Date().toISOString();
                    const docRef = await window.firestore.addDoc(window.firestore.collection(window.db, 'contracts'), eventData);
                    await addToHistory('Contrato creado', docRef.id, eventData);
                    closeEventModal();
                    showSuccessScreen(docRef.id);
                    loadEvents();
                    showSyncIndicator('success', '‚úÖ Contrato creado');
                }
            } catch (error) {
                console.error('Error al guardar evento:', error);
                showSyncIndicator('error', '‚ùå Error al guardar contrato');
                alert('Error al guardar el evento. Por favor intenta de nuevo.');
            }
        }

        function showSuccessScreen(contractId) {
            const baseUrl = window.location.origin + window.location.pathname;
            const contractUrl = `${baseUrl}?contract=${contractId}`;
            
            document.getElementById('contractLink').value = contractUrl;
            document.getElementById('successScreen').classList.remove('hidden');
        }

        function closeSuccessScreen() {
            document.getElementById('successScreen').classList.add('hidden');
        }

        function copyContractLink() {
            const linkInput = document.getElementById('contractLink');
            linkInput.select();
            document.execCommand('copy');
            
            const btn = document.getElementById('copyLinkBtn');
            const originalText = btn.textContent;
            btn.textContent = '¬°Copiado!';
            btn.classList.add('bg-green-600');
            btn.classList.remove('bg-blue-600');
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.classList.remove('bg-green-600');
                btn.classList.add('bg-blue-600');
            }, 2000);
        }

        async function loadEvents() {
            try {
                showSyncIndicator('syncing', 'üîÑ Cargando contratos...');
                const q = window.firestore.query(
                    window.firestore.collection(window.db, 'contracts'),
                    window.firestore.orderBy('createdAt', 'desc')
                );
                const querySnapshot = await window.firestore.getDocs(q);
                
                const events = [];
                querySnapshot.forEach((doc) => {
                    events.push({ id: doc.id, ...doc.data() });
                });
                
                displayEvents(events);
                showSyncIndicator('success', '‚úÖ Contratos actualizados');
            } catch (error) {
                console.error('Error al cargar eventos:', error);
                showSyncIndicator('error', '‚ùå Error al cargar contratos');
            }
        }

        function displayEvents(events) {
            const tbody = document.getElementById('eventsTable');
            tbody.innerHTML = '';
            
            events.forEach(event => {
                const createdByName = event.createdBy && administrators[event.createdBy] ? 
                    administrators[event.createdBy].name : 'Desconocido';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-mono font-bold text-blue-600">${event.id.substring(0, 8).toUpperCase()}</div>
                        <div class="text-xs text-gray-500">ID: ${event.id}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${event.clientName}</div>
                        <div class="text-sm text-gray-500">${event.clientPhone}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${event.eventType}</div>
                        <div class="text-sm text-gray-500">${event.eventLocation}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${new Date(event.eventDate).toLocaleDateString('es-ES')}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(event.status)}">
                            ${getStatusText(event.status)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${createdByName}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                        <button onclick="editEvent('${event.id}')" class="text-blue-600 hover:text-blue-900">Editar</button>
                        <button onclick="viewContract('${event.id}')" class="text-green-600 hover:text-green-900">Ver Contrato</button>
                        <button onclick="copyContractUrl('${event.id}')" class="text-purple-600 hover:text-purple-900">Copiar Enlace</button>
                        <button onclick="deleteEvent('${event.id}')" class="text-red-600 hover:text-red-900">Eliminar</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function getStatusColor(status) {
            switch(status) {
                case 'pendiente': return 'bg-yellow-100 text-yellow-800';
                case 'firmado': return 'bg-blue-100 text-blue-800';
                case 'completado': return 'bg-green-100 text-green-800';
                case 'cancelado': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'pendiente': return 'Pendiente';
                case 'firmado': return 'Firmado';
                case 'completado': return 'Completado';
                case 'cancelado': return 'Cancelado';
                default: return 'Desconocido';
            }
        }

        function filterEvents() {
            // Implementar filtrado de eventos
            loadEvents();
        }

        async function editEvent(eventId) {
            try {
                const docRef = window.firestore.doc(window.db, 'contracts', eventId);
                const docSnap = await window.firestore.getDoc(docRef);
                
                if (docSnap.exists()) {
                    openEventModal({ id: eventId, ...docSnap.data() });
                }
            } catch (error) {
                console.error('Error al cargar evento:', error);
            }
        }

        function viewContract(eventId) {
            const baseUrl = window.location.origin + window.location.pathname;
            window.open(`${baseUrl}?contract=${eventId}`, '_blank');
        }

        function copyContractUrl(eventId) {
            const baseUrl = window.location.origin + window.location.pathname;
            const contractUrl = `${baseUrl}?contract=${eventId}`;
            
            navigator.clipboard.writeText(contractUrl).then(() => {
                alert('Enlace copiado al portapapeles');
            });
        }

        async function deleteEvent(eventId) {
            if (confirm('¬øEst√°s seguro de que deseas eliminar este contrato? Esta acci√≥n no se puede deshacer.')) {
                try {
                    const docRef = window.firestore.doc(window.db, 'contracts', eventId);
                    const docSnap = await window.firestore.getDoc(docRef);
                    const contractData = docSnap.data();
                    
                    await window.firestore.deleteDoc(docRef);
                    await addToHistory('Contrato eliminado', eventId, contractData);
                    loadEvents();
                    alert('Contrato eliminado exitosamente');
                } catch (error) {
                    console.error('Error al eliminar contrato:', error);
                    alert('Error al eliminar el contrato');
                }
            }
        }

        // Vista del cliente
        async function loadContract(contractId) {
            try {
                const docRef = window.firestore.doc(window.db, 'contracts', contractId);
                const docSnap = await window.firestore.getDoc(docRef);
                
                if (docSnap.exists()) {
                    currentContract = { id: contractId, ...docSnap.data() };
                    displayContract(currentContract);
                } else {
                    alert('Contrato no encontrado');
                }
            } catch (error) {
                console.error('Error al cargar contrato:', error);
                alert('Error al cargar el contrato');
            }
        }

        function displayContract(contract) {
            const content = document.getElementById('contractContent');
            const currentDate = new Date().toLocaleDateString('es-ES', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            });
            
            // Obtener informaci√≥n del administrador que cre√≥ el contrato
            const adminInfo = contract.createdBy && administrators[contract.createdBy] ? 
                administrators[contract.createdBy] : 
                { name: 'Administrador', signature: null };
            
            content.innerHTML = `
                <div class="elegant-border rounded-lg bg-white relative z-10 overflow-hidden">
                    <!-- Encabezado Elegante -->
                    <div class="contract-header p-8 text-center relative">
                        <div class="absolute inset-0 opacity-10">
                            <svg viewBox="0 0 100 100" class="w-full h-full">
                                <path d="M20,50 Q30,30 40,50 T60,50 T80,50" stroke="currentColor" stroke-width="0.5" fill="none"/>
                                <circle cx="50" cy="50" r="30" stroke="currentColor" stroke-width="0.3" fill="none"/>
                            </svg>
                        </div>
                        <div class="relative z-10">
                            <div class="flex justify-center mb-4">
                                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-lg">
                                    <span class="text-2xl">üéµ</span>
                                </div>
                            </div>
                            <h1 class="text-4xl font-bold mb-2 tracking-wide">${contractSettings.companyName}</h1>
                            <div class="ornamental-divider"></div>
                            <h2 class="text-xl font-semibold tracking-wider">CONTRATO DE SERVICIOS MUSICALES</h2>
                            <p class="text-sm mt-4 opacity-90">Contrato No. ${contract.id.substring(0, 8).toUpperCase()} - Versi√≥n ${contract.contractVersion}.0</p>
                            <p class="text-sm opacity-90">${contractSettings.contractPlace}, ${currentDate}</p>
                        </div>
                    </div>
                    
                    <div class="p-8">
                        <!-- Comparecencia -->
                        <div class="mb-10 text-sm leading-relaxed">
                            <h3 class="font-bold dolce-brown mb-6 text-center text-lg tracking-wide">COMPARECENCIA</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div class="dolce-cream border-2 border-amber-200 rounded-lg p-6 shadow-md">
                                    <h4 class="font-bold dolce-brown mb-4 text-center border-b border-amber-300 pb-2">EL PRESTADOR</h4>
                                    <div class="space-y-2">
                                        <p><strong class="dolce-brown">${contractSettings.companyName}</strong></p>
                                        <p>Representado por: <strong class="dolce-gold">${adminInfo.name}</strong></p>
                                        <p>Nacionalidad: ${contractSettings.companyNationality}</p>
                                        ${contractSettings.showRFC === 'true' ? `<p>Identificaci√≥n: ${contractSettings.companyId}</p>` : ''}
                                        <p>Tel√©fono: ${contractSettings.companyPhone}</p>
                                        <p>Email: ${contractSettings.companyEmail}</p>
                                    </div>
                                </div>
                                <div class="dolce-cream border-2 border-amber-200 rounded-lg p-6 shadow-md">
                                    <h4 class="font-bold dolce-brown mb-4 text-center border-b border-amber-300 pb-2">EL CONTRATANTE</h4>
                                    <div class="space-y-2">
                                        <p><strong class="dolce-brown">${contract.clientName}</strong></p>
                                        <p>Tel√©fono: ${contract.clientPhone}</p>
                                        ${contract.clientEmail ? `<p>Email: ${contract.clientEmail}</p>` : ''}
                                        <div class="mt-4 pt-3 border-t border-amber-300">
                                            <p><strong class="dolce-gold">Evento:</strong> ${contract.eventType}</p>
                                            <p><strong class="dolce-gold">Fecha:</strong> ${new Date(contract.eventDate).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                            <p><strong class="dolce-gold">Hora:</strong> ${contract.eventTime}</p>
                                            <p><strong class="dolce-gold">Lugar:</strong> ${contract.eventLocation}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    
                        <!-- Cl√°usulas -->
                        <div class="space-y-8 text-sm leading-relaxed">
                            <!-- Cl√°usula Primera -->
                            <div class="clause-border rounded-lg p-6 shadow-sm">
                                <h4 class="font-bold dolce-brown mb-4 text-base flex items-center">
                                    <span class="w-8 h-8 bg-gradient-to-r from-amber-400 to-amber-600 rounded-full flex items-center justify-center text-white text-sm mr-3">1</span>
                                    OBJETO DEL CONTRATO
                                </h4>
                                <p class="mb-3 text-gray-700">${contractSettings.serviceDescription}</p>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                    <p><strong class="dolce-gold">Duraci√≥n del servicio:</strong> ${contract.eventDuration} horas</p>
                                    <p><strong class="dolce-gold">Precio total:</strong> $${parseFloat(contract.eventPrice).toLocaleString('es-MX')} MXN</p>
                                </div>
                                <p class="mt-3"><strong class="dolce-gold">Servicios espec√≠ficos:</strong> ${contract.eventServices || 'Seg√∫n cotizaci√≥n anexa'}</p>
                            </div>
                            
                            <!-- Cl√°usula Segunda -->
                            <div class="clause-border rounded-lg p-6 shadow-sm">
                                <h4 class="font-bold dolce-brown mb-4 text-base flex items-center">
                                    <span class="w-8 h-8 bg-gradient-to-r from-amber-400 to-amber-600 rounded-full flex items-center justify-center text-white text-sm mr-3">2</span>
                                    POL√çTICA DE PAGO Y CANCELACI√ìN
                                </h4>
                                <p class="mb-3 text-gray-700"><strong class="dolce-gold">Forma de pago:</strong> ${contractSettings.paymentPolicy}</p>
                                <p class="text-gray-700"><strong class="dolce-gold">Cancelaciones:</strong> ${contractSettings.cancellationPolicy}</p>
                            </div>
                            
                            <!-- Cl√°usula Tercera -->
                            <div class="clause-border rounded-lg p-6 shadow-sm">
                                <h4 class="font-bold dolce-brown mb-4 text-base flex items-center">
                                    <span class="w-8 h-8 bg-gradient-to-r from-amber-400 to-amber-600 rounded-full flex items-center justify-center text-white text-sm mr-3">3</span>
                                    REPERTORIO Y M√öSICA ADICIONAL
                                </h4>
                                <p class="mb-3 text-gray-700">${contractSettings.repertoirePolicy}</p>
                                <p class="text-gray-700">${contractSettings.additionalSongsCost}</p>
                            </div>
                            
                            <!-- Cl√°usula Cuarta -->
                            <div class="clause-border rounded-lg p-6 shadow-sm">
                                <h4 class="font-bold dolce-brown mb-4 text-base flex items-center">
                                    <span class="w-8 h-8 bg-gradient-to-r from-amber-400 to-amber-600 rounded-full flex items-center justify-center text-white text-sm mr-3">4</span>
                                    LOG√çSTICA Y RESPONSABILIDADES
                                </h4>
                                <p class="mb-3 text-gray-700">${contractSettings.logisticsRequirements}</p>
                                <p class="text-gray-700">${contractSettings.equipmentResponsibility}</p>
                            </div>
                            
                            <!-- Cl√°usula Quinta -->
                            <div class="clause-border rounded-lg p-6 shadow-sm">
                                <h4 class="font-bold dolce-brown mb-4 text-base flex items-center">
                                    <span class="w-8 h-8 bg-gradient-to-r from-amber-400 to-amber-600 rounded-full flex items-center justify-center text-white text-sm mr-3">5</span>
                                    TIEMPO EXTRA Y PUNTUALIDAD
                                </h4>
                                <p class="mb-3 text-gray-700"><strong class="dolce-gold">Llegada:</strong> ${contractSettings.arrivalTime}</p>
                                <p class="text-gray-700">${contractSettings.overtimePolicy}</p>
                            </div>
                            
                            <!-- Cl√°usula Sexta -->
                            <div class="clause-border rounded-lg p-6 shadow-sm">
                                <h4 class="font-bold dolce-brown mb-4 text-base flex items-center">
                                    <span class="w-8 h-8 bg-gradient-to-r from-amber-400 to-amber-600 rounded-full flex items-center justify-center text-white text-sm mr-3">6</span>
                                    DERECHOS DE IMAGEN Y CONFIDENCIALIDAD
                                </h4>
                                <p class="mb-3 text-gray-700">${contractSettings.imageRights}</p>
                                <p class="text-gray-700">${contractSettings.confidentiality}</p>
                            </div>
                            
                            <!-- Cl√°usula S√©ptima -->
                            <div class="clause-border rounded-lg p-6 shadow-sm">
                                <h4 class="font-bold dolce-brown mb-4 text-base flex items-center">
                                    <span class="w-8 h-8 bg-gradient-to-r from-amber-400 to-amber-600 rounded-full flex items-center justify-center text-white text-sm mr-3">7</span>
                                    SOLUCI√ìN DE CONTROVERSIAS
                                </h4>
                                <p class="text-gray-700">${contractSettings.disputeResolution}</p>
                            </div>
                            
                            <!-- Cl√°usula Octava -->
                            <div class="clause-border rounded-lg p-6 shadow-sm">
                                <h4 class="font-bold dolce-brown mb-4 text-base flex items-center">
                                    <span class="w-8 h-8 bg-gradient-to-r from-amber-400 to-amber-600 rounded-full flex items-center justify-center text-white text-sm mr-3">8</span>
                                    VALIDEZ DE FIRMA DIGITAL
                                </h4>
                                <p class="text-gray-700">${contractSettings.digitalSignature}</p>
                            </div>
                            
                            <!-- T√©rminos Adicionales -->
                            ${contract.eventTerms ? `
                            <div class="clause-border rounded-lg p-6 shadow-sm">
                                <h4 class="font-bold dolce-brown mb-4 text-base flex items-center">
                                    <span class="w-8 h-8 bg-gradient-to-r from-amber-400 to-amber-600 rounded-full flex items-center justify-center text-white text-sm mr-3">+</span>
                                    T√âRMINOS Y CONDICIONES ADICIONALES
                                </h4>
                                <p class="text-gray-700">${contract.eventTerms}</p>
                            </div>
                            ` : ''}
                        </div>
                    
                        <!-- Secci√≥n de Firmas al Final -->
                        <div class="mt-12 pt-8">
                            <div class="ornamental-divider mb-8"></div>
                            <h3 class="font-bold dolce-brown mb-8 text-center text-lg tracking-wide">FIRMAS</h3>
                            
                            <div class="signature-section p-8 mx-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                                    <!-- Firma del Prestador -->
                                    <div class="text-center">
                                        <div class="mb-6">
                                            ${adminInfo.signature ? 
                                                `<div class="flex justify-center mb-4">
                                                    <img src="${adminInfo.signature}" alt="Firma del prestador" class="max-h-20 max-w-48 border-b-2 border-amber-400">
                                                </div>` : 
                                                '<div class="h-20 border-b-2 border-amber-400 flex items-end justify-center pb-2"><span class="text-gray-400 text-sm">Sin firma digital</span></div>'
                                            }
                                        </div>
                                        <div class="space-y-1">
                                            <p class="font-bold dolce-brown text-lg">${adminInfo.name}</p>
                                            <p class="dolce-gold font-semibold">${contractSettings.companyName}</p>
                                            <p class="text-sm text-gray-600 uppercase tracking-wide">EL PRESTADOR</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Firma del Cliente -->
                                    <div class="text-center">
                                        <div class="mb-6">
                                            ${contract.clientSignature ? 
                                                `<div class="flex justify-center mb-4">
                                                    <img src="${contract.clientSignature}" alt="Firma del cliente" class="max-h-20 max-w-48 border-b-2 border-amber-400">
                                                </div>` : 
                                                '<div class="h-20 border-b-2 border-amber-400 flex items-end justify-center pb-2"><span class="text-gray-400 text-sm">Pendiente de firma</span></div>'
                                            }
                                        </div>
                                        <div class="space-y-1">
                                            <p class="font-bold dolce-brown text-lg">${contract.clientName}</p>
                                            <p class="text-sm text-gray-600 uppercase tracking-wide">EL CONTRATANTE</p>
                                            ${contract.clientSignature ? `<p class="text-xs text-green-600 mt-2">‚úì Firmado el ${new Date(contract.signedAt || contract.createdAt).toLocaleDateString('es-ES')}</p>` : ''}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Informaci√≥n adicional de firmas -->
                                <div class="mt-8 pt-6 border-t border-amber-200 text-center text-xs text-gray-500">
                                    <p class="mb-2">Las firmas digitales en este documento tienen validez legal conforme a la legislaci√≥n mexicana vigente</p>
                                    <p>Contrato generado el ${new Date(contract.createdAt).toLocaleString('es-ES')}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Informaci√≥n de Contacto -->
                        <div class="mt-8 pt-6 border-t border-amber-200 text-center text-xs text-gray-500 dolce-cream rounded-lg p-4 mx-4">
                            <div class="flex justify-center mb-2">
                                <span class="text-lg">üéµ</span>
                            </div>
                            <p class="font-semibold dolce-brown">Para dudas o aclaraciones</p>
                            <p class="dolce-gold">${contractSettings.companyPhone} | ${contractSettings.companyEmail}</p>
                            <div class="ornamental-divider mt-4"></div>
                            <p class="text-xs mt-2 italic">Dolce Ensamble - M√∫sica que toca el coraz√≥n</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Configuraci√≥n del pad de firma
        function setupSignaturePad() {
            const canvas = document.getElementById('signaturePad');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            let isDrawing = false;
            
            // Configurar canvas
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            
            // Eventos de mouse
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Eventos t√°ctiles
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
            
            function startDrawing(e) {
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                ctx.beginPath();
                ctx.moveTo(x, y);
            }
            
            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                ctx.lineTo(x, y);
                ctx.stroke();
            }
            
            function stopDrawing() {
                isDrawing = false;
            }
            
            function handleTouch(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                                 e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }
        }

        function clearSignature() {
            const canvas = document.getElementById('signaturePad');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        async function saveSignature() {
            const canvas = document.getElementById('signaturePad');
            const signatureData = canvas.toDataURL();
            
            // Verificar que hay una firma
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const hasSignature = imageData.data.some(channel => channel !== 0);
            
            if (!hasSignature) {
                alert('Por favor, dibuja tu firma antes de guardar');
                return;
            }
            
            try {
                // Actualizar el contrato con la firma
                const docRef = window.firestore.doc(window.db, 'contracts', currentContract.id);
                await window.firestore.updateDoc(docRef, {
                    clientSignature: signatureData,
                    signedAt: new Date().toISOString(),
                    status: 'firmado'
                });
                
                // Agregar al historial
                await addToHistory('Contrato firmado', currentContract.id, currentContract);
                
                // Actualizar la vista
                currentContract.clientSignature = signatureData;
                currentContract.status = 'firmado';
                displayContract(currentContract);
                
                alert('¬°Firma guardada exitosamente! El contrato ha sido firmado.');
            } catch (error) {
                console.error('Error al guardar firma:', error);
                alert('Error al guardar la firma. Por favor intenta de nuevo.');
            }
        }

        async function downloadContractPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                
                // Capturar el contenido del contrato
                const contractElement = document.getElementById('contractContent');
                const canvas = await html2canvas(contractElement, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true
                });
                
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 190;
                const pageHeight = 295;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                
                let position = 10;
                
                pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight + 10;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                const fileName = `Contrato_${currentContract.id.substring(0, 8).toUpperCase()}_${currentContract.clientName.replace(/\s+/g, '_')}.pdf`;
                pdf.save(fileName);
            } catch (error) {
                console.error('Error al generar PDF:', error);
                alert('Error al generar el PDF. Por favor intenta de nuevo.');
            }
        }

        function contactAdmin() {
            const adminInfo = currentContract.createdBy && administrators[currentContract.createdBy] ? 
                administrators[currentContract.createdBy] : null;
            
            if (adminInfo) {
                const message = `Hola, tengo una consulta sobre el contrato ${currentContract.id.substring(0, 8).toUpperCase()} para el evento ${currentContract.eventType} del ${new Date(currentContract.eventDate).toLocaleDateString('es-ES')}.`;
                const whatsappUrl = `https://wa.me/${contractSettings.companyPhone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
            } else {
                const message = `Hola, tengo una consulta sobre mi contrato ${currentContract.id.substring(0, 8).toUpperCase()}.`;
                const whatsappUrl = `https://wa.me/${contractSettings.companyPhone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97fababb8276d749',t:'MTc1Nzk2NjYyNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
