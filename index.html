<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dolce Ensamble - Gesti√≥n de Contratos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBEPQwNyDTwj7-5fC0ksJQH6JRBmzielBA",
            authDomain: "app-contratos-dolce-ensamble.firebaseapp.com",
            projectId: "app-contratos-dolce-ensamble",
            storageBucket: "app-contratos-dolce-ensamble.firebasestorage.app",
            messagingSenderId: "892161363930",
            appId: "1:892161363930:web:c98f9f7ed7bc53e3c63ae3",
            measurementId: "G-NF3HCSFY7Y"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db;
        window.firestore = { collection, addDoc, getDocs, doc, getDoc, updateDoc, query, orderBy };
    </script>
    <style>
        .signature-pad {
            border: 2px dashed #d1d5db;
            cursor: crosshair;
        }
        .contract-bg {
            background-image: url('https://i.ibb.co/nSdYQnh/Plantilla-1.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
        }
        .contract-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
        }
        .elegant-border {
            border: 3px solid #1e40af;
            border-image: linear-gradient(45deg, #1e40af, #3b82f6, #1e40af) 1;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Pantalla de Login -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-900 to-purple-900">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">üéµ Dolce Ensamble</h1>
                <p class="text-gray-600">Panel de Administraci√≥n</p>
            </div>
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a</label>
                    <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ingresa tu contrase√±a">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                    Iniciar Sesi√≥n
                </button>
            </form>
        </div>
    </div>

    <!-- Panel de Administrador -->
    <div id="adminPanel" class="hidden">
        <nav class="bg-white shadow-lg border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <h1 class="text-xl font-bold text-gray-800">üéµ Dolce Ensamble - Panel Admin</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button id="newEventBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                            + Nuevo Evento
                        </button>
                        <button id="contractSettingsBtn" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition duration-200">
                            ‚öôÔ∏è Configurar Contrato
                        </button>
                        <button id="logoutBtn" class="text-gray-600 hover:text-gray-800">Cerrar Sesi√≥n</button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- B√∫squeda y Filtros -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <input type="text" id="searchInput" placeholder="Buscar por nombre, tel√©fono o c√≥digo..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Todos los estados</option>
                        <option value="pendiente">Pendiente</option>
                        <option value="firmado">Firmado</option>
                        <option value="completado">Completado</option>
                    </select>
                </div>
            </div>

            <!-- Tabla de Eventos -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-800">Eventos y Contratos</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Evento</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="eventsTable" class="bg-white divide-y divide-gray-200">
                            <!-- Los eventos se cargar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Configuraci√≥n del Contrato -->
    <div id="contractSettingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto m-4">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-800">Configuraci√≥n del Contrato</h2>
                <button id="closeContractSettings" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form id="contractSettingsForm" class="p-6 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre de la Empresa</label>
                        <input type="text" id="companyName" value="DOLCE ENSAMBLE" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tel√©fono de Contacto</label>
                        <input type="tel" id="companyPhone" value="+52 811 047 4854" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email de Contacto</label>
                        <input type="email" id="companyEmail" value="contacto@dolceensamble.com" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">T√©rminos de Pago por Defecto</label>
                        <textarea id="defaultPaymentTerms" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">50% de anticipo para apartar la fecha, 50% restante el d√≠a del evento.</textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pol√≠tica de Cancelaci√≥n</label>
                        <textarea id="cancellationPolicy" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">En caso de cancelaci√≥n por parte del cliente con menos de 15 d√≠as de anticipaci√≥n, no se reembolsar√° el anticipo.</textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cl√°usulas Adicionales del Contrato</label>
                        <textarea id="additionalClauses" rows="6" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">FUERZA MAYOR: Dolce Ensamble no se hace responsable por cancelaciones debido a causas de fuerza mayor (clima extremo, emergencias sanitarias, etc.).
EQUIPAMIENTO: Dolce Ensamble proporcionar√° el equipo de sonido necesario para el evento.
RESPONSABILIDADES: El cliente se compromete a proporcionar un espacio adecuado y acceso a energ√≠a el√©ctrica.
MODIFICACIONES: Cualquier cambio al presente contrato deber√° ser acordado por escrito por ambas partes.
JURISDICCI√ìN: Este contrato se rige por las leyes mexicanas y cualquier disputa ser√° resuelta en los tribunales competentes.</textarea>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-4 pt-6 border-t">
                    <button type="button" id="cancelContractSettings" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                        Guardar Configuraci√≥n
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Nuevo/Editar Evento -->
    <div id="eventModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto m-4">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h2 id="modalTitle" class="text-xl font-semibold text-gray-800">Nuevo Evento</h2>
                <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form id="eventForm" class="p-6 space-y-6">
                <input type="hidden" id="editingEventId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre del Cliente *</label>
                        <input type="text" id="clientName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tel√©fono *</label>
                        <input type="tel" id="clientPhone" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="clientEmail" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Evento *</label>
                        <select id="eventType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Seleccionar...</option>
                            <option value="boda">Boda</option>
                            <option value="quinceanos">XV A√±os</option>
                            <option value="corporativo">Evento Corporativo</option>
                            <option value="cumpleanos">Cumplea√±os</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Fecha del Evento *</label>
                        <input type="date" id="eventDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Hora de Inicio *</label>
                        <input type="time" id="eventTime" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lugar del Evento *</label>
                        <input type="text" id="eventLocation" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Duraci√≥n (horas) *</label>
                        <input type="number" id="eventDuration" required min="1" max="12" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Precio Total *</label>
                        <input type="number" id="eventPrice" required min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Estado del Contrato</label>
                        <select id="contractStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="pendiente">Pendiente</option>
                            <option value="firmado">Firmado</option>
                            <option value="completado">Completado</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Servicios Incluidos</label>
                        <textarea id="eventServices" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Describe los servicios incluidos..."></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">T√©rminos y Condiciones Adicionales</label>
                        <textarea id="eventTerms" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="T√©rminos espec√≠ficos del contrato..."></textarea>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-4 pt-6 border-t">
                    <button type="button" id="cancelBtn" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Guardar Evento
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Pantalla de √âxito con Enlace -->
    <div id="successScreen" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4 p-6">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                    <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">¬°Evento Creado Exitosamente!</h3>
                <p class="text-sm text-gray-500 mb-6">Comparte este enlace con tu cliente para que pueda ver y firmar el contrato:</p>
                
                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                    <p class="text-xs text-gray-500 mb-2">Enlace del contrato:</p>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="contractLink" readonly class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded bg-white">
                        <button id="copyLinkBtn" class="px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                            Copiar
                        </button>
                    </div>
                </div>
                
                <button id="closeSuccessBtn" class="w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Vista del Cliente -->
    <div id="clientView" class="hidden min-h-screen bg-gray-100">
        <div class="max-w-4xl mx-auto py-8 px-4">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6">
                    <h1 class="text-2xl font-bold">üéµ Dolce Ensamble</h1>
                    <p class="text-blue-100">Contrato de Servicios Musicales</p>
                </div>
                
                <div id="contractContent" class="contract-bg p-8">
                    <!-- El contenido del contrato se generar√° aqu√≠ -->
                </div>
                
                <div id="signatureSection" class="p-6 border-t bg-gray-50">
                    <h3 class="text-lg font-semibold mb-4">Firma del Cliente</h3>
                    <div class="mb-4">
                        <canvas id="signaturePad" width="600" height="200" class="signature-pad bg-white rounded-lg w-full max-w-2xl"></canvas>
                    </div>
                    <div class="flex flex-wrap gap-4">
                        <button id="clearSignature" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                            Limpiar Firma
                        </button>
                        <button id="saveSignature" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            Guardar Firma
                        </button>
                        <button id="downloadPDF" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Descargar PDF
                        </button>
                        <button id="contactAdmin" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            Contactar Administrador
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentUser = null;
        let currentContract = null;
        let isDrawing = false;
        let signatureData = null;
        let contractSettings = {
            companyName: 'DOLCE ENSAMBLE',
            companyPhone: '+52 811 047 4854',
            companyEmail: 'contacto@dolceensamble.com',
            defaultPaymentTerms: '50% de anticipo para apartar la fecha, 50% restante el d√≠a del evento.',
            cancellationPolicy: 'En caso de cancelaci√≥n por parte del cliente con menos de 15 d√≠as de anticipaci√≥n, no se reembolsar√° el anticipo.',
            additionalClauses: `FUERZA MAYOR: Dolce Ensamble no se hace responsable por cancelaciones debido a causas de fuerza mayor (clima extremo, emergencias sanitarias, etc.).
EQUIPAMIENTO: Dolce Ensamble proporcionar√° el equipo de sonido necesario para el evento.
RESPONSABILIDADES: El cliente se compromete a proporcionar un espacio adecuado y acceso a energ√≠a el√©ctrica.
MODIFICACIONES: Cualquier cambio al presente contrato deber√° ser acordado por escrito por ambas partes.
JURISDICCI√ìN: Este contrato se rige por las leyes mexicanas y cualquier disputa ser√° resuelta en los tribunales competentes.`
        };

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            checkURLParams();
            setupEventListeners();
            loadContractSettings();
        });

        function checkURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const contractId = urlParams.get('contract');
            
            if (contractId) {
                showClientView(contractId);
            } else {
                showLoginScreen();
            }
        }

        function setupEventListeners() {
            // Login
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Admin Panel
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('newEventBtn').addEventListener('click', () => openEventModal());
            document.getElementById('contractSettingsBtn').addEventListener('click', openContractSettings);
            document.getElementById('closeModal').addEventListener('click', closeEventModal);
            document.getElementById('cancelBtn').addEventListener('click', closeEventModal);
            document.getElementById('eventForm').addEventListener('submit', handleEventSubmit);
            
            // Contract Settings
            document.getElementById('closeContractSettings').addEventListener('click', closeContractSettings);
            document.getElementById('cancelContractSettings').addEventListener('click', closeContractSettings);
            document.getElementById('contractSettingsForm').addEventListener('submit', handleContractSettingsSubmit);
            
            // B√∫squeda
            document.getElementById('searchInput').addEventListener('input', filterEvents);
            document.getElementById('statusFilter').addEventListener('change', filterEvents);
            
            // Success Screen
            document.getElementById('copyLinkBtn').addEventListener('click', copyContractLink);
            document.getElementById('closeSuccessBtn').addEventListener('click', closeSuccessScreen);
            
            // Cliente
            setupSignaturePad();
            document.getElementById('clearSignature').addEventListener('click', clearSignature);
            document.getElementById('saveSignature').addEventListener('click', saveSignature);
            document.getElementById('downloadPDF').addEventListener('click', downloadContractPDF);
            document.getElementById('contactAdmin').addEventListener('click', contactAdmin);
        }

        // Configuraci√≥n del contrato
        function openContractSettings() {
            document.getElementById('contractSettingsModal').classList.remove('hidden');
            fillContractSettingsForm();
        }

        function closeContractSettings() {
            document.getElementById('contractSettingsModal').classList.add('hidden');
        }

        function fillContractSettingsForm() {
            document.getElementById('companyName').value = contractSettings.companyName;
            document.getElementById('companyPhone').value = contractSettings.companyPhone;
            document.getElementById('companyEmail').value = contractSettings.companyEmail;
            document.getElementById('defaultPaymentTerms').value = contractSettings.defaultPaymentTerms;
            document.getElementById('cancellationPolicy').value = contractSettings.cancellationPolicy;
            document.getElementById('additionalClauses').value = contractSettings.additionalClauses;
        }

        async function handleContractSettingsSubmit(e) {
            e.preventDefault();
            
            contractSettings = {
                companyName: document.getElementById('companyName').value,
                companyPhone: document.getElementById('companyPhone').value,
                companyEmail: document.getElementById('companyEmail').value,
                defaultPaymentTerms: document.getElementById('defaultPaymentTerms').value,
                cancellationPolicy: document.getElementById('cancellationPolicy').value,
                additionalClauses: document.getElementById('additionalClauses').value
            };

            try {
                await saveContractSettings();
                closeContractSettings();
                alert('Configuraci√≥n guardada exitosamente');
            } catch (error) {
                console.error('Error al guardar configuraci√≥n:', error);
                alert('Error al guardar la configuraci√≥n');
            }
        }

        async function loadContractSettings() {
            try {
                const docRef = window.firestore.doc(window.db, 'settings', 'contract');
                const docSnap = await window.firestore.getDoc(docRef);
                
                if (docSnap.exists()) {
                    contractSettings = { ...contractSettings, ...docSnap.data() };
                }
            } catch (error) {
                console.error('Error al cargar configuraci√≥n:', error);
            }
        }

        async function saveContractSettings() {
            try {
                const docRef = window.firestore.doc(window.db, 'settings', 'contract');
                await window.firestore.updateDoc(docRef, contractSettings);
            } catch (error) {
                // Si el documento no existe, lo creamos
                await window.firestore.addDoc(window.firestore.collection(window.db, 'settings'), {
                    ...contractSettings,
                    id: 'contract'
                });
            }
        }

        // Autenticaci√≥n
        function handleLogin(e) {
            e.preventDefault();
            const password = document.getElementById('password').value;
            
            if (password === 'admin123') {
                currentUser = 'admin';
                showAdminPanel();
                loadEvents();
            } else {
                alert('Contrase√±a incorrecta');
            }
        }

        function logout() {
            currentUser = null;
            showLoginScreen();
        }

        // Navegaci√≥n entre pantallas
        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('clientView').classList.add('hidden');
        }

        function showAdminPanel() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
            document.getElementById('clientView').classList.add('hidden');
        }

        function showClientView(contractId) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('clientView').classList.remove('hidden');
            loadContract(contractId);
        }

        // Gesti√≥n de eventos
        function openEventModal(eventData = null) {
            document.getElementById('eventModal').classList.remove('hidden');
            document.getElementById('modalTitle').textContent = eventData ? 'Editar Evento' : 'Nuevo Evento';
            
            if (eventData) {
                fillEventForm(eventData);
            } else {
                document.getElementById('eventForm').reset();
                document.getElementById('contractStatus').value = 'pendiente';
            }
        }

        function closeEventModal() {
            document.getElementById('eventModal').classList.add('hidden');
            document.getElementById('eventForm').reset();
            document.getElementById('editingEventId').value = '';
        }

        function fillEventForm(eventData) {
            document.getElementById('editingEventId').value = eventData.id || '';
            document.getElementById('clientName').value = eventData.clientName || '';
            document.getElementById('clientPhone').value = eventData.clientPhone || '';
            document.getElementById('clientEmail').value = eventData.clientEmail || '';
            document.getElementById('eventType').value = eventData.eventType || '';
            document.getElementById('eventDate').value = eventData.eventDate || '';
            document.getElementById('eventTime').value = eventData.eventTime || '';
            document.getElementById('eventLocation').value = eventData.eventLocation || '';
            document.getElementById('eventDuration').value = eventData.eventDuration || '';
            document.getElementById('eventPrice').value = eventData.eventPrice || '';
            document.getElementById('contractStatus').value = eventData.status || 'pendiente';
            document.getElementById('eventServices').value = eventData.eventServices || '';
            document.getElementById('eventTerms').value = eventData.eventTerms || '';
        }

        async function handleEventSubmit(e) {
            e.preventDefault();
            
            const eventData = {
                clientName: document.getElementById('clientName').value,
                clientPhone: document.getElementById('clientPhone').value,
                clientEmail: document.getElementById('clientEmail').value,
                eventType: document.getElementById('eventType').value,
                eventDate: document.getElementById('eventDate').value,
                eventTime: document.getElementById('eventTime').value,
                eventLocation: document.getElementById('eventLocation').value,
                eventDuration: document.getElementById('eventDuration').value,
                eventPrice: document.getElementById('eventPrice').value,
                status: document.getElementById('contractStatus').value,
                eventServices: document.getElementById('eventServices').value,
                eventTerms: document.getElementById('eventTerms').value,
                contractVersion: 1,
                adminSignature: true
            };

            const editingId = document.getElementById('editingEventId').value;

            try {
                if (editingId) {
                    // Actualizar evento existente
                    const docRef = window.firestore.doc(window.db, 'contracts', editingId);
                    await window.firestore.updateDoc(docRef, {
                        ...eventData,
                        updatedAt: new Date().toISOString()
                    });
                    closeEventModal();
                    loadEvents();
                    alert('Evento actualizado exitosamente');
                } else {
                    // Crear nuevo evento
                    eventData.createdAt = new Date().toISOString();
                    const docRef = await window.firestore.addDoc(window.firestore.collection(window.db, 'contracts'), eventData);
                    closeEventModal();
                    showSuccessScreen(docRef.id);
                    loadEvents();
                }
            } catch (error) {
                console.error('Error al guardar evento:', error);
                alert('Error al guardar el evento. Por favor intenta de nuevo.');
            }
        }

        function showSuccessScreen(contractId) {
            const baseUrl = window.location.origin + window.location.pathname;
            const contractUrl = `${baseUrl}?contract=${contractId}`;
            
            document.getElementById('contractLink').value = contractUrl;
            document.getElementById('successScreen').classList.remove('hidden');
        }

        function closeSuccessScreen() {
            document.getElementById('successScreen').classList.add('hidden');
        }

        function copyContractLink() {
            const linkInput = document.getElementById('contractLink');
            linkInput.select();
            document.execCommand('copy');
            
            const btn = document.getElementById('copyLinkBtn');
            const originalText = btn.textContent;
            btn.textContent = '¬°Copiado!';
            btn.classList.add('bg-green-600');
            btn.classList.remove('bg-blue-600');
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.classList.remove('bg-green-600');
                btn.classList.add('bg-blue-600');
            }, 2000);
        }

        async function loadEvents() {
            try {
                const q = window.firestore.query(
                    window.firestore.collection(window.db, 'contracts'),
                    window.firestore.orderBy('createdAt', 'desc')
                );
                const querySnapshot = await window.firestore.getDocs(q);
                
                const events = [];
                querySnapshot.forEach((doc) => {
                    events.push({ id: doc.id, ...doc.data() });
                });
                
                displayEvents(events);
            } catch (error) {
                console.error('Error al cargar eventos:', error);
            }
        }

        function displayEvents(events) {
            const tbody = document.getElementById('eventsTable');
            tbody.innerHTML = '';
            
            events.forEach(event => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${event.clientName}</div>
                        <div class="text-sm text-gray-500">${event.clientPhone}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${event.eventType}</div>
                        <div class="text-sm text-gray-500">${event.eventLocation}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${new Date(event.eventDate).toLocaleDateString('es-ES')}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(event.status)}">
                            ${getStatusText(event.status)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                        <button onclick="editEvent('${event.id}')" class="text-blue-600 hover:text-blue-900">Editar</button>
                        <button onclick="viewContract('${event.id}')" class="text-green-600 hover:text-green-900">Ver Contrato</button>
                        <button onclick="copyContractUrl('${event.id}')" class="text-purple-600 hover:text-purple-900">Copiar Enlace</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function getStatusColor(status) {
            switch(status) {
                case 'pendiente': return 'bg-yellow-100 text-yellow-800';
                case 'firmado': return 'bg-blue-100 text-blue-800';
                case 'completado': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'pendiente': return 'Pendiente';
                case 'firmado': return 'Firmado';
                case 'completado': return 'Completado';
                default: return 'Desconocido';
            }
        }

        function filterEvents() {
            // Implementar filtrado de eventos
            loadEvents();
        }

        async function editEvent(eventId) {
            try {
                const docRef = window.firestore.doc(window.db, 'contracts', eventId);
                const docSnap = await window.firestore.getDoc(docRef);
                
                if (docSnap.exists()) {
                    openEventModal({ id: eventId, ...docSnap.data() });
                }
            } catch (error) {
                console.error('Error al cargar evento:', error);
            }
        }

        function viewContract(eventId) {
            const baseUrl = window.location.origin + window.location.pathname;
            window.open(`${baseUrl}?contract=${eventId}`, '_blank');
        }

        function copyContractUrl(eventId) {
            const baseUrl = window.location.origin + window.location.pathname;
            const contractUrl = `${baseUrl}?contract=${eventId}`;
            
            navigator.clipboard.writeText(contractUrl).then(() => {
                alert('Enlace copiado al portapapeles');
            });
        }

        // Vista del cliente
        async function loadContract(contractId) {
            try {
                const docRef = window.firestore.doc(window.db, 'contracts', contractId);
                const docSnap = await window.firestore.getDoc(docRef);
                
                if (docSnap.exists()) {
                    currentContract = { id: contractId, ...docSnap.data() };
                    displayContract(currentContract);
                } else {
                    alert('Contrato no encontrado');
                }
            } catch (error) {
                console.error('Error al cargar contrato:', error);
                alert('Error al cargar el contrato');
            }
        }

        function displayContract(contract) {
            const content = document.getElementById('contractContent');
            const clauses = contractSettings.additionalClauses.split('\n').map((clause, index) => 
                `<p>${index + 4}. <strong>${clause}</strong></p>`
            ).join('');
            
            content.innerHTML = `
                <div class="elegant-border rounded-lg p-8 bg-white relative z-10">
                    <div class="text-center mb-8">
                        <h1 class="text-3xl font-bold text-blue-800 mb-2">üéµ ${contractSettings.companyName}</h1>
                        <h2 class="text-xl font-semibold text-gray-700">CONTRATO DE SERVICIOS MUSICALES</h2>
                        <p class="text-sm text-gray-500 mt-2">Contrato No. ${contract.id.substring(0, 8).toUpperCase()} - Versi√≥n ${contract.contractVersion}</p>
                    </div>
                    
                    <div class="space-y-6 text-sm leading-relaxed">
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <h3 class="font-semibold text-gray-800 mb-2">DATOS DEL CLIENTE:</h3>
                                <p><strong>Nombre:</strong> ${contract.clientName}</p>
                                <p><strong>Tel√©fono:</strong> ${contract.clientPhone}</p>
                                ${contract.clientEmail ? `<p><strong>Email:</strong> ${contract.clientEmail}</p>` : ''}
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-800 mb-2">DATOS DEL EVENTO:</h3>
                                <p><strong>Tipo:</strong> ${contract.eventType}</p>
                                <p><strong>Fecha:</strong> ${new Date(contract.eventDate).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                <p><strong>Hora:</strong> ${contract.eventTime}</p>
                                <p><strong>Duraci√≥n:</strong> ${contract.eventDuration} horas</p>
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-2">LUGAR DEL EVENTO:</h3>
                            <p>${contract.eventLocation}</p>
                        </div>
                        
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-2">SERVICIOS INCLUIDOS:</h3>
                            <p>${contract.eventServices || 'Servicios musicales profesionales seg√∫n lo acordado verbalmente.'}</p>
                        </div>
                        
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-2">T√âRMINOS Y CONDICIONES:</h3>
                            <div class="space-y-2">
                                <p>1. <strong>PRECIO TOTAL:</strong> $${parseFloat(contract.eventPrice).toLocaleString('es-MX')} MXN</p>
                                <p>2. <strong>FORMA DE PAGO:</strong> ${contractSettings.defaultPaymentTerms}</p>
                                <p>3. <strong>CANCELACIONES:</strong> ${contractSettings.cancellationPolicy}</p>
                                ${clauses}
                                ${contract.eventTerms ? `<p><strong>T√âRMINOS ADICIONALES:</strong> ${contract.eventTerms}</p>` : ''}
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-8 mt-12 pt-8 border-t-2 border-gray-200">
                            <div class="text-center">
                                <div class="border-b-2 border-gray-400 pb-2 mb-2">
                                    <p class="text-lg font-semibold">${contractSettings.companyName}</p>
                                    <p class="text-sm text-gray-600">Representante Legal</p>
                                </div>
                                <p class="text-xs text-gray-500">Firma del Prestador de Servicios</p>
                            </div>
                            <div class="text-center">
                                <div class="border-b-2 border-gray-400 pb-2 mb-2" id="clientSignatureArea">
                                    ${contract.clientSignature ? 
                                        `<img src="${contract.clientSignature}" alt="Firma del cliente" class="max-h-16 mx-auto">` : 
                                        '<p class="text-gray-400 py-4">Pendiente de firma</p>'
                                    }
                                </div>
                                <p class="text-xs text-gray-500">Firma del Cliente</p>
                                <p class="text-xs font-medium">${contract.clientName}</p>
                            </div>
                        </div>
                        
                        <div class="text-center text-xs text-gray-400 mt-8 pt-4 border-t">
                            <p>Contrato generado el ${new Date(contract.createdAt).toLocaleDateString('es-ES')}</p>
                            <p>${contractSettings.companyName} - Servicios Musicales Profesionales</p>
                            <p>Contacto: ${contractSettings.companyPhone}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Firma digital
        function setupSignaturePad() {
            const canvas = document.getElementById('signaturePad');
            const ctx = canvas.getContext('2d');
            
            // Configurar canvas
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            
            // Eventos de mouse
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Eventos t√°ctiles
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
            
            function startDrawing(e) {
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                ctx.beginPath();
                ctx.moveTo(x, y);
            }
            
            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                ctx.lineTo(x, y);
                ctx.stroke();
            }
            
            function stopDrawing() {
                isDrawing = false;
            }
            
            function handleTouch(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                                 e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }
        }

        function clearSignature() {
            const canvas = document.getElementById('signaturePad');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            signatureData = null;
        }

        async function saveSignature() {
            const canvas = document.getElementById('signaturePad');
            signatureData = canvas.toDataURL();
            
            try {
                const docRef = window.firestore.doc(window.db, 'contracts', currentContract.id);
                await window.firestore.updateDoc(docRef, {
                    clientSignature: signatureData,
                    status: 'firmado',
                    signedAt: new Date().toISOString()
                });
                
                currentContract.clientSignature = signatureData;
                currentContract.status = 'firmado';
                displayContract(currentContract);
                
                alert('¬°Firma guardada exitosamente!');
            } catch (error) {
                console.error('Error al guardar firma:', error);
                alert('Error al guardar la firma. Por favor intenta de nuevo.');
            }
        }

        async function downloadContractPDF() {
            if (!currentContract.clientSignature) {
                alert('Por favor firma el contrato antes de descargarlo.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            // Crear elemento temporal para el PDF con mejor formato
            const pdfContent = document.createElement('div');
            pdfContent.style.width = '794px'; // A4 width in pixels at 96 DPI
            pdfContent.style.padding = '40px';
            pdfContent.style.backgroundColor = 'white';
            pdfContent.style.fontFamily = 'Arial, sans-serif';
            pdfContent.style.fontSize = '14px';
            pdfContent.style.lineHeight = '1.6';
            pdfContent.style.color = '#333';
            pdfContent.style.backgroundImage = 'url(https://i.ibb.co/nSdYQnh/Plantilla-1.jpg)';
            pdfContent.style.backgroundSize = 'cover';
            pdfContent.style.backgroundPosition = 'center';
            pdfContent.style.backgroundRepeat = 'no-repeat';
            
            const clauses = contractSettings.additionalClauses.split('\n').map((clause, index) => 
                `<p style="margin: 8px 0;"><strong>${index + 4}. ${clause}</strong></p>`
            ).join('');
            
            pdfContent.innerHTML = `
                <div style="background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 10px; border: 3px solid #1e40af;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h1 style="font-size: 28px; font-weight: bold; color: #1e40af; margin: 0;">üéµ ${contractSettings.companyName}</h1>
                        <h2 style="font-size: 20px; font-weight: 600; color: #374151; margin: 10px 0;">CONTRATO DE SERVICIOS MUSICALES</h2>
                        <p style="font-size: 12px; color: #6b7280; margin: 5px 0;">Contrato No. ${currentContract.id.substring(0, 8).toUpperCase()} - Versi√≥n ${currentContract.contractVersion}</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 25px;">
                        <div>
                            <h3 style="font-weight: bold; color: #374151; margin-bottom: 10px; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px;">DATOS DEL CLIENTE:</h3>
                            <p style="margin: 5px 0;"><strong>Nombre:</strong> ${currentContract.clientName}</p>
                            <p style="margin: 5px 0;"><strong>Tel√©fono:</strong> ${currentContract.clientPhone}</p>
                            ${currentContract.clientEmail ? `<p style="margin: 5px 0;"><strong>Email:</strong> ${currentContract.clientEmail}</p>` : ''}
                        </div>
                        <div>
                            <h3 style="font-weight: bold; color: #374151; margin-bottom: 10px; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px;">DATOS DEL EVENTO:</h3>
                            <p style="margin: 5px 0;"><strong>Tipo:</strong> ${currentContract.eventType}</p>
                            <p style="margin: 5px 0;"><strong>Fecha:</strong> ${new Date(currentContract.eventDate).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                            <p style="margin: 5px 0;"><strong>Hora:</strong> ${currentContract.eventTime}</p>
                            <p style="margin: 5px 0;"><strong>Duraci√≥n:</strong> ${currentContract.eventDuration} horas</p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="font-weight: bold; color: #374151; margin-bottom: 10px; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px;">LUGAR DEL EVENTO:</h3>
                        <p style="margin: 5px 0;">${currentContract.eventLocation}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="font-weight: bold; color: #374151; margin-bottom: 10px; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px;">SERVICIOS INCLUIDOS:</h3>
                        <p style="margin: 5px 0;">${currentContract.eventServices || 'Servicios musicales profesionales seg√∫n lo acordado verbalmente.'}</p>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h3 style="font-weight: bold; color: #374151; margin-bottom: 10px; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px;">T√âRMINOS Y CONDICIONES:</h3>
                        <div style="line-height: 1.8;">
                            <p style="margin: 8px 0;"><strong>1. PRECIO TOTAL:</strong> $${parseFloat(currentContract.eventPrice).toLocaleString('es-MX')} MXN</p>
                            <p style="margin: 8px 0;"><strong>2. FORMA DE PAGO:</strong> ${contractSettings.defaultPaymentTerms}</p>
                            <p style="margin: 8px 0;"><strong>3. CANCELACIONES:</strong> ${contractSettings.cancellationPolicy}</p>
                            ${clauses}
                            ${currentContract.eventTerms ? `<p style="margin: 8px 0;"><strong>T√âRMINOS ADICIONALES:</strong> ${currentContract.eventTerms}</p>` : ''}
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-top: 40px; padding-top: 30px; border-top: 2px solid #374151;">
                        <div style="text-align: center;">
                            <div style="border-bottom: 2px solid #374151; padding-bottom: 10px; margin-bottom: 10px; height: 60px; display: flex; align-items: center; justify-content: center;">
                                <div>
                                    <p style="font-size: 16px; font-weight: bold; margin: 0;">${contractSettings.companyName}</p>
                                    <p style="font-size: 12px; color: #6b7280; margin: 5px 0;">Representante Legal</p>
                                </div>
                            </div>
                            <p style="font-size: 11px; color: #6b7280; margin: 0;">Firma del Prestador de Servicios</p>
                        </div>
                        <div style="text-align: center;">
                            <div style="border-bottom: 2px solid #374151; padding-bottom: 10px; margin-bottom: 10px; height: 60px; display: flex; align-items: center; justify-content: center;">
                                ${currentContract.clientSignature ? 
                                    `<img src="${currentContract.clientSignature}" style="max-height: 50px; max-width: 200px;">` : 
                                    '<p style="color: #9ca3af; margin: 0;">Pendiente de firma</p>'
                                }
                            </div>
                            <p style="font-size: 11px; color: #6b7280; margin: 0;">Firma del Cliente</p>
                            <p style="font-size: 11px; font-weight: 600; margin: 5px 0;">${currentContract.clientName}</p>
                        </div>
                    </div>
                    
                    <div style="text-align: center; font-size: 10px; color: #9ca3af; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                        <p style="margin: 2px 0;">Contrato generado el ${new Date(currentContract.createdAt).toLocaleDateString('es-ES')}</p>
                        <p style="margin: 2px 0;">${contractSettings.companyName} - Servicios Musicales Profesionales</p>
                        <p style="margin: 2px 0;">Contacto: ${contractSettings.companyPhone}</p>
                    </div>
                </div>
            `;
            
            // Agregar al DOM temporalmente
            document.body.appendChild(pdfContent);
            
            try {
                const canvas = await html2canvas(pdfContent, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: null,
                    width: 794,
                    height: 1123 // A4 height
                });
                
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 297; // A4 height in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;
                
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                pdf.save(`Contrato_${currentContract.clientName.replace(/\s+/g, '_')}_${currentContract.id.substring(0, 8)}.pdf`);
                
                // Remover elemento temporal
                document.body.removeChild(pdfContent);
                
            } catch (error) {
                console.error('Error al generar PDF:', error);
                alert('Error al generar el PDF. Por favor intenta de nuevo.');
                if (document.body.contains(pdfContent)) {
                    document.body.removeChild(pdfContent);
                }
            }
        }

        function contactAdmin() {
            const message = `Hola, soy ${currentContract.clientName}. Mi contrato es ${currentContract.id.substring(0, 8).toUpperCase()} para el evento del ${new Date(currentContract.eventDate).toLocaleDateString('es-ES')}. Necesito contactarte sobre:`;
            const whatsappUrl = `https://wa.me/528110474854?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97f39936f623c915',t:'MTc1Nzg5MTg1NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
